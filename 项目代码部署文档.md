# RbacAdminé¡¹ç›®ä»£ç éƒ¨ç½²æ–‡æ¡£

## 1. é¡¹ç›®æ¦‚è¿°

RbacAdminæ˜¯ä¸€ä¸ªåŸºäºGoè¯­è¨€å¼€å‘çš„RBACæƒé™ç®¡ç†ç³»ç»Ÿåç«¯é¡¹ç›®ï¼Œæä¾›å®Œæ•´çš„ç”¨æˆ·è®¤è¯ã€æƒé™æ§åˆ¶ã€è§’è‰²ç®¡ç†ç­‰åŠŸèƒ½ã€‚è¯¥ç³»ç»Ÿé‡‡ç”¨ç°ä»£åŒ–çš„å¾®æœåŠ¡æ¶æ„æ€æƒ³è®¾è®¡ï¼Œæ”¯æŒå¤šæ•°æ®åº“ç±»å‹ã€é«˜æ€§èƒ½ç¼“å­˜ã€å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿå’Œå®‰å…¨çš„JWTè®¤è¯æœºåˆ¶ã€‚

## 2. æŠ€æœ¯æ ˆæ¸…å•

| æŠ€æœ¯/æ¡†æ¶ | ç‰ˆæœ¬/è¯´æ˜ | ç”¨é€” | æº¯æº |
|---------|---------|------|------|
| Go | 1.25.1 | ä¸»è¦å¼€å‘è¯­è¨€ | <mcfile name="go.mod" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\go.mod"></mcfile> |
| Gin | æœ€æ–°ç‰ˆ | Webæ¡†æ¶ï¼Œå¤„ç†HTTPè¯·æ±‚ | <mcfile name="routes\enter.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\routes\enter.go"></mcfile> |
| GORM | æœ€æ–°ç‰ˆ | ORMæ¡†æ¶ï¼Œæ•°æ®åº“æ“ä½œ | <mcfile name="core\db.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\core\db.go"></mcfile> |
| Redis | æœ€æ–°ç‰ˆ | ç¼“å­˜æœåŠ¡ï¼Œå­˜å‚¨ä¼šè¯å’Œä¸´æ—¶æ•°æ® | <mcfile name="core\redis.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\core\redis.go"></mcfile> |
| Casbin | æœ€æ–°ç‰ˆ | æƒé™ç®¡ç†æ¡†æ¶ï¼Œå®ç°RBACæ¨¡å‹ | <mcfile name="core\casbin.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\core\casbin.go"></mcfile> |
| JWT | æœ€æ–°ç‰ˆ | è®¤è¯ä»¤ç‰Œç”Ÿæˆä¸éªŒè¯ | <mcfile name="api\user_api\login.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\api\user_api\login.go"></mcfile> |
| MySQL/PostgreSQL/SQLite | å¤šæ•°æ®åº“æ”¯æŒ | æ•°æ®æŒä¹…åŒ–å­˜å‚¨ | <mcfile name="core\db.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\core\db.go"></mcfile> |

## 3. é¡¹ç›®ç›®å½•ç»“æ„

```
rbacAdmin/
â”œâ”€â”€ api/                # APIæ¥å£å®ç°
â”‚   â”œâ”€â”€ captcha_api/    # éªŒè¯ç ç›¸å…³æ¥å£
â”‚   â”œâ”€â”€ email_api/      # é‚®ç®±ç›¸å…³æ¥å£
â”‚   â”œâ”€â”€ user_api/       # ç”¨æˆ·ç›¸å…³æ¥å£
â”‚   â””â”€â”€ enter.go        # APIå…¥å£æ–‡ä»¶
â”œâ”€â”€ cmd/                # å‘½ä»¤è¡Œå·¥å…·å’Œç¤ºä¾‹
â”œâ”€â”€ common/             # é€šç”¨ç»„ä»¶
â”‚   â””â”€â”€ resp/           # ç»Ÿä¸€å“åº”æ ¼å¼
â”œâ”€â”€ config/             # é…ç½®å®šä¹‰
â”œâ”€â”€ core/               # æ ¸å¿ƒåŠŸèƒ½å®ç°
â”œâ”€â”€ flags/              # å‘½ä»¤è¡Œå‚æ•°
â”œâ”€â”€ main.go             # é¡¹ç›®å…¥å£æ–‡ä»¶
â””â”€â”€ settings.yaml       # é…ç½®æ–‡ä»¶
```

## 4. é¡¹ç›®è¿è¡Œæ¶æ„ä¸æµç¨‹

### 4.1 é¡¹ç›®å¯åŠ¨æµç¨‹

1. **åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ**
   åœ¨main.goä¸­é€šè¿‡`core.InitLogger("logs")`è°ƒç”¨ï¼Œè®¾ç½®æ—¥å¿—æ–‡ä»¶å­˜å‚¨è·¯å¾„ä¸º"logs"ç›®å½•ã€‚æ—¥å¿—ç³»ç»ŸåŸºäºlogrusåº“å®ç°ï¼Œé…ç½®äº†è‡ªå®šä¹‰æ ¼å¼å™¨ã€æ§åˆ¶å°å½©è‰²è¾“å‡ºã€æŒ‰æ—¥æœŸåˆ†å‰²çš„æ–‡ä»¶å­˜å‚¨ï¼Œå¹¶æ”¯æŒé”™è¯¯æ—¥å¿—å•ç‹¬è®°å½•ã€‚

2. **è¯»å–é…ç½®æ–‡ä»¶ï¼ˆsettings.yamlï¼‰**
   é€šè¿‡`global.Config = core.ReadConfig()`è¯»å–é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨viperåº“è§£æYAMLæ ¼å¼çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç³»ç»Ÿè®¾ç½®ã€æ•°æ®åº“è¿æ¥ã€Redisé…ç½®ã€JWTè®¾ç½®ã€éªŒè¯ç å’Œé‚®ç®±é…ç½®ç­‰ã€‚

3. **åˆå§‹åŒ–æ•°æ®åº“è¿æ¥**
   è°ƒç”¨`global.DB = core.InitGorm()`åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ï¼Œæ”¯æŒMySQLã€PostgreSQLå’ŒSQLiteä¸‰ç§æ•°æ®åº“ç±»å‹ï¼Œé…ç½®äº†è¿æ¥æ± å‚æ•°ï¼ˆæœ€å¤§ç©ºé—²è¿æ¥æ•°10ã€æœ€å¤§æ‰“å¼€è¿æ¥æ•°100ã€è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ1å°æ—¶ï¼‰ï¼Œå¹¶æ‰§è¡Œæ•°æ®åº“è¿æ¥æµ‹è¯•ã€‚

4. **åˆå§‹åŒ–Casbinæƒé™æ¨¡å‹**
   é€šè¿‡`global.Casbin = core.InitCasbin()`åˆå§‹åŒ–åŸºäºRBACçš„æƒé™æ§åˆ¶æ¨¡å‹ï¼Œä½¿ç”¨gorm-adapterè¿æ¥æ•°æ®åº“å­˜å‚¨ç­–ç•¥è§„åˆ™ï¼Œå¹¶è®¾ç½®ç­–ç•¥ç¼“å­˜è¿‡æœŸæ—¶é—´ä¸º60åˆ†é’Ÿã€‚

5. **åˆå§‹åŒ–Redisç¼“å­˜**
   è°ƒç”¨`global.Redis = core.InitRedis()`åˆå§‹åŒ–Rediså®¢æˆ·ç«¯è¿æ¥ï¼Œä½¿ç”¨go-redis/v9åº“ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½®è¿æ¥å‚æ•°ï¼ˆåœ°å€ã€å¯†ç ã€æ•°æ®åº“ã€è¶…æ—¶æ—¶é—´ç­‰ï¼‰ï¼Œå¹¶éªŒè¯Redisè¿æ¥çŠ¶æ€ã€‚

6. **å¯åŠ¨é‚®ä»¶éªŒè¯ç æ¸…ç†å®šæ—¶å™¨**
   æ‰§è¡Œ`captcha.EmailStore.StartCleanupTimer()`å¯åŠ¨å®šæ—¶å™¨ï¼Œå®šæœŸæ¸…ç†è¿‡æœŸçš„é‚®ä»¶éªŒè¯ç ã€‚

7. **é…ç½®å¹¶å¯åŠ¨HTTPæœåŠ¡å’Œè·¯ç”±**
   ä¾æ¬¡è°ƒç”¨`flags.Run()`å’Œ`route.Run()`ï¼Œé…ç½®Gin Webæ¡†æ¶ã€æ³¨å†ŒAPIè·¯ç”±ã€è®¾ç½®ä¸­é—´ä»¶ï¼Œå¹¶å¯åŠ¨HTTPæœåŠ¡å™¨ã€‚

### 4.2 æ ¸å¿ƒä¸šåŠ¡æµç¨‹

1. **ç”¨æˆ·è®¤è¯æµç¨‹**
   - ç”¨æˆ·é€šè¿‡APIæäº¤ç™»å½•è¯·æ±‚ï¼ŒåŒ…å«ç”¨æˆ·åã€å¯†ç å’ŒéªŒè¯ç 
   - ç³»ç»Ÿé¦–å…ˆéªŒè¯éªŒè¯ç çš„æœ‰æ•ˆæ€§
   - ç„¶åé€šè¿‡æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶éªŒè¯å¯†ç çš„æ­£ç¡®æ€§
   - éªŒè¯é€šè¿‡åï¼Œç”ŸæˆJWTä»¤ç‰Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯
   - ç›¸å…³APIå®ç°ä½äº`api/user_api/login.go`

2. **æƒé™éªŒè¯æµç¨‹**
   - å®¢æˆ·ç«¯è¯·æ±‚æºå¸¦JWTä»¤ç‰Œ
   - ç³»ç»Ÿä¸­é—´ä»¶éªŒè¯JWTä»¤ç‰Œçš„æœ‰æ•ˆæ€§ï¼ŒåŒ…æ‹¬ä»¤ç‰Œæ˜¯å¦è¿‡æœŸã€ç­¾åæ˜¯å¦æ­£ç¡®
   - éªŒè¯é€šè¿‡åï¼Œä»ä»¤ç‰Œä¸­è§£æå‡ºç”¨æˆ·ä¿¡æ¯
   - ä½¿ç”¨Casbinè¿›è¡Œæƒé™æ£€æŸ¥ï¼ŒéªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™æ‰§è¡Œè¯·æ±‚çš„æ“ä½œ
   - æƒé™éªŒè¯å¤±è´¥æ—¶ï¼Œè¿”å›403é”™è¯¯

3. **æ•°æ®è®¿é—®æµç¨‹**
   - é€šè¿‡GORMæ¡†æ¶ä¸æ•°æ®åº“äº¤äº’ï¼Œæ‰§è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œ
   - å¯¹çƒ­ç‚¹æ•°æ®ä½¿ç”¨Redisè¿›è¡Œç¼“å­˜ï¼Œæé«˜è®¿é—®æ€§èƒ½
   - æ•°æ®åº“æ“ä½œæ”¯æŒäº‹åŠ¡å¤„ç†ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
   - æ”¯æŒå¤šç§æ•°æ®åº“ç±»å‹ï¼ˆMySQLã€PostgreSQLã€SQLiteï¼‰çš„æ— ç¼åˆ‡æ¢

## 5. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ä»£ç å®ç°

### 5.1 é…ç½®ç®¡ç†æ¨¡å—

```go
// core/read_config.go
package core

import (
	"os"
	"rbacAdmin/config"
	"rbacAdmin/flags"

	"github.com/sirupsen/logrus"
	"gopkg.in/yaml.v3"
)

// ReadConfig è¯»å–å¹¶è§£æé…ç½®æ–‡ä»¶
// è¿”å›å€¼:
//   - *config.Config: è§£æåçš„é…ç½®å¯¹è±¡æŒ‡é’ˆ
func ReadConfig() *config.Config {
	// ä»å‘½ä»¤è¡Œå‚æ•°ä¸­è·å–é…ç½®æ–‡ä»¶è·¯å¾„å¹¶è¯»å–æ–‡ä»¶å†…å®¹
	byteData, err := os.ReadFile(flags.FlagOptions.File)
	if err != nil {
		// è¯»å–å¤±è´¥æ—¶è®°å½•è‡´å‘½é”™è¯¯å¹¶ç»ˆæ­¢ç¨‹åº
		logrus.Fatalf("âŒ é…ç½®æ–‡ä»¶è¯»å–å¤±è´¥: %v", err.Error())
		return nil
	}
	// åˆ›å»ºé…ç½®å¯¹è±¡å¹¶ä½¿ç”¨yaml.v3åº“è§£æé…ç½®å†…å®¹
	var c *config.Config
	err = yaml.Unmarshal(byteData, &c)
	if err != nil {
		// è§£æå¤±è´¥æ—¶è®°å½•è‡´å‘½é”™è¯¯å¹¶ç»ˆæ­¢ç¨‹åº
		logrus.Fatalf("âŒ é…ç½®æ–‡ä»¶æ ¼å¼è§£æå¤±è´¥: %v", err.Error())
		return nil
	}
	// é…ç½®åŠ è½½æˆåŠŸï¼Œè®°å½•æ—¥å¿—
	logrus.Infof("âœ… é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ: %s", flags.FlagOptions.File)
	// è¿”å›è§£æåçš„é…ç½®å¯¹è±¡
	return c
}
```
<mcfile name="read_config.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\core\read_config.go"></mcfile>

### 5.2 æ•°æ®åº“æ¨¡å—

```go
// core/db.go
package core

import (
	"fmt"
	"rbacAdmin/global"
	"time"

	"github.com/glebarez/sqlite"
	"github.com/sirupsen/logrus"
	"gorm.io/driver/mysql"
	"gorm.io/driver/postgres"
	"gorm.io/gorm"
)

// InitGorm åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
// è¿”å›å€¼:
//   - *gorm.DB: åˆå§‹åŒ–åçš„GORMæ•°æ®åº“è¿æ¥å¯¹è±¡
func InitGorm() (database *gorm.DB) {
	// è·å–å…¨å±€é…ç½®ä¸­çš„æ•°æ®åº“é…ç½®
	var db = global.Config.DB
	var dialector gorm.Dialector

	// æ ¹æ®æ•°æ®åº“ç±»å‹æ„å»ºè¿æ¥å­—ç¬¦ä¸²å’Œå¯¹åº”çš„dialector
	switch db.MODE {
	case "mysql":
		// MySQLè¿æ¥å­—ç¬¦ä¸²æ ¼å¼
		dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=utf8mb4&parseTime=True&loc=Local",
			db.USER, db.PASSWORD, db.HOST, db.PORT, db.DbNAME)
		dialector = mysql.Open(dsn)
	case "pgsql", "postgres", "postgresql":
		// PostgreSQLè¿æ¥å­—ç¬¦ä¸²æ ¼å¼
		dsn := fmt.Sprintf("host=%s user=%s password=%s dbname=%s port=%d sslmode=disable TimeZone=Asia/Shanghai",
			db.HOST, db.USER, db.PASSWORD, db.DbNAME, db.PORT)
		dialector = postgres.Open(dsn)
	case "sqlite":
		// SQLiteè¿æ¥æ–¹å¼ï¼ˆç›´æ¥æŒ‡å®šæ•°æ®åº“æ–‡ä»¶è·¯å¾„ï¼‰
		dialector = sqlite.Open(db.HOST)
	case "":
		// æœªé…ç½®æ•°æ®åº“ç±»å‹æ—¶è®°å½•è‡´å‘½é”™è¯¯
		logrus.Fatalf("æœªé…ç½®æ•°æ®åº“ç±»å‹")
		return nil
	default:
		// ä¸æ”¯æŒçš„æ•°æ®åº“ç±»å‹æ—¶è®°å½•è‡´å‘½é”™è¯¯
		logrus.Fatalf("ä¸æ”¯æŒçš„æ•°æ®åº“ç±»å‹: %s", db.MODE)
	}

	// æ‰“å¼€æ•°æ®åº“è¿æ¥ï¼Œé…ç½®GORM
	database, err := gorm.Open(dialector, &gorm.Config{
		DisableForeignKeyConstraintWhenMigrating: true, // ä¸ç”Ÿæˆå¤–é”®çº¦æŸ
	})
	if err != nil {
		// æ•°æ®åº“è¿æ¥å¤±è´¥æ—¶è®°å½•è‡´å‘½é”™è¯¯
		logrus.Fatalf("âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: %v", err)
		return nil
	}

	// è·å–åº•å±‚çš„sql.DBå¯¹è±¡ï¼Œç”¨äºé…ç½®è¿æ¥æ± 
	sqlDB, err := database.DB()
	if err != nil {
		logrus.Fatalf("è·å–æ•°æ®åº“è¿æ¥æ± å¤±è´¥: %v", err)
		return nil
	}

	// æµ‹è¯•æ•°æ®åº“è¿æ¥
	err = sqlDB.Ping()
	if err != nil {
		// è¿æ¥æµ‹è¯•å¤±è´¥æ—¶è®°å½•è‡´å‘½é”™è¯¯
		logrus.Fatalf("âŒ æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: %v", err)
		return nil
	}

	// è®¾ç½®è¿æ¥æ± å‚æ•°
	sqlDB.SetMaxIdleConns(10)           // æœ€å¤§ç©ºé—²è¿æ¥æ•°
	sqlDB.SetMaxOpenConns(100)          // æœ€å¤§æ‰“å¼€è¿æ¥æ•°
	sqlDB.SetConnMaxLifetime(time.Hour) // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ

	// æ•°æ®åº“è¿æ¥æˆåŠŸï¼Œè®°å½•æ—¥å¿—
	logrus.Infof("âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ: %s", db.MODE)
	return database
}
```
<mcfile name="db.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\core\db.go"></mcfile>

### 5.3 Redisç¼“å­˜æ¨¡å—

```go
// core/redis.go
package core

import (
	"context"
	"rbacAdmin/global"

	"github.com/redis/go-redis/v9"
	"github.com/sirupsen/logrus"
)

// InitRedis åˆå§‹åŒ–Rediså®¢æˆ·ç«¯è¿æ¥
// è¿”å›å€¼:
//   - *redis.Client: åˆå§‹åŒ–åçš„Rediså®¢æˆ·ç«¯å¯¹è±¡
func InitRedis() *redis.Client {
	// è·å–å…¨å±€é…ç½®ä¸­çš„Redisé…ç½®
	r := global.Config.Redis
	// åˆ›å»ºRediså®¢æˆ·ç«¯å¹¶é…ç½®è¿æ¥å‚æ•°
	c := redis.NewClient(&redis.Options{
		Addr:     r.Addr,     // RedisæœåŠ¡å™¨åœ°å€å’Œç«¯å£
		Password: r.Password, // Rediså¯†ç ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
		DB:       r.DB,       // Redisæ•°æ®åº“ç´¢å¼•
	})
	// æµ‹è¯•Redisè¿æ¥
	if _, err := c.Ping(context.Background()).Result(); err != nil {
		// è¿æ¥å¤±è´¥æ—¶è®°å½•è‡´å‘½é”™è¯¯
		logrus.Fatalf("âŒ Redisè¿æ¥å¤±è´¥: %v", err)
		return nil
	}
	// Redisè¿æ¥æˆåŠŸï¼Œè®°å½•æ—¥å¿—
	logrus.Infof("âœ… Redisè¿æ¥æˆåŠŸ: %s", r.Addr)
	return c
}
```
<mcfile name="redis.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\core\redis.go"></mcfile>

### 5.4 æƒé™æ§åˆ¶æ¨¡å—

```go
// core/casbin.go
package core

import (
	"rbacAdmin/global"

	"github.com/casbin/casbin/v2"
	"github.com/casbin/casbin/v2/model"
	gormadapter "github.com/casbin/gorm-adapter/v3"
	"github.com/sirupsen/logrus"
)

// InitCasbin åˆå§‹åŒ–Casbinæƒé™æ§åˆ¶æ¨¡å‹
// è¿”å›å€¼:
//   - *casbin.CachedEnforcer: åˆå§‹åŒ–åçš„Casbinç¼“å­˜æ‰§è¡Œå™¨
func InitCasbin() *casbin.CachedEnforcer {
	// åˆ›å»ºåŸºäºGORMçš„Casbiné€‚é…å™¨ï¼Œç”¨äºä»æ•°æ®åº“åŠ è½½ç­–ç•¥è§„åˆ™
	a, _ := gormadapter.NewAdapterByDB(global.DB)
	// å®šä¹‰Casbinæƒé™æ¨¡å‹
	casbinModel := `
[request_definition]
# è¯·æ±‚å®šä¹‰ï¼šsubjectï¼ˆç”¨æˆ·ï¼‰, objectï¼ˆèµ„æºï¼‰, actionï¼ˆæ“ä½œï¼‰
r = sub, obj, act

[policy_definition]
# ç­–ç•¥å®šä¹‰ï¼šå®šä¹‰ç­–ç•¥è§„åˆ™çš„æ ¼å¼
p = sub, obj, act

[policy_effect]
# ç­–ç•¥æ•ˆæœï¼šæœ‰ä»»æ„ä¸€æ¡ç­–ç•¥å…è®¸åˆ™å…è®¸è®¿é—®
e = some(where (p.eft == allow))

[matchers]
# åŒ¹é…å™¨ï¼šå®šä¹‰è¯·æ±‚å’Œç­–ç•¥çš„åŒ¹é…è§„åˆ™
m = r.sub == p.sub && r.obj == p.obj && r.act == p.act
`
	// ä»å­—ç¬¦ä¸²åˆ›å»ºCasbinæ¨¡å‹
	m, err := model.NewModelFromString(casbinModel)
	if err != nil {
		// æ¨¡å‹åˆ›å»ºå¤±è´¥æ—¶è®°å½•è‡´å‘½é”™è¯¯
		logrus.Fatalf("åˆå§‹åŒ–Casbinå¤±è´¥: %v", err)
	}
	// åˆ›å»ºå¸¦ç¼“å­˜çš„Casbinæ‰§è¡Œå™¨
	e, _ := casbin.NewCachedEnforcer(m, a)
	// è®¾ç½®ç­–ç•¥ç¼“å­˜è¿‡æœŸæ—¶é—´ä¸º60åˆ†é’Ÿ
	e.SetExpireTime(60 * 60)
	// ä»æ•°æ®åº“åŠ è½½ç­–ç•¥è§„åˆ™
	_ = e.LoadPolicy()
	// è®°å½•Casbinåˆå§‹åŒ–æˆåŠŸçš„æ—¥å¿—
	logrus.Infof("âœ… Casbinæƒé™æ¨¡å‹åˆå§‹åŒ–æˆåŠŸ")
	return e
}
```
<mcfile name="casbin.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\core\casbin.go"></mcfile>

### 5.5 æ—¥å¿—ç³»ç»Ÿæ¨¡å—

```go
// core/logger.go
package core

import (
	"bytes"
	"fmt"
	"os"
	"path"
	"sync"

	"github.com/sirupsen/logrus"
)

// Mylogger è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼å™¨ç»“æ„ä½“
// å®ç°logrus.Formatteræ¥å£ï¼Œç”¨äºè‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼
// å­—æ®µ:
//   - LogLevel: YAMLé…ç½®ä¸­çš„æ—¥å¿—çº§åˆ«

type Mylogger struct {
	LogLevel string `yaml:"log_level"` // YAMLé…ç½®ä¸­çš„æ—¥å¿—çº§åˆ«
}

// MyHook æ—¥å¿—é’©å­ç»“æ„ä½“ï¼Œå®ç°logrus.Hookæ¥å£
// ç”¨äºå¤„ç†æ—¥å¿—æ–‡ä»¶çš„å†™å…¥å’ŒæŒ‰æ—¥æœŸåˆ†å‰²
// å­—æ®µ:
//   - logPath: æ—¥å¿—æ–‡ä»¶å­˜å‚¨è·¯å¾„
//   - file: æ™®é€šæ—¥å¿—æ–‡ä»¶å¥æŸ„
//   - errFile: é”™è¯¯æ—¥å¿—æ–‡ä»¶å¥æŸ„
//   - fileDate: å½“å‰æ—¥å¿—æ–‡ä»¶æ—¥æœŸï¼ˆç”¨äºæŒ‰æ—¥æœŸåˆ†å‰²ï¼‰
//   - mu: äº’æ–¥é”ï¼Œä¿è¯å¹¶å‘å®‰å…¨

type MyHook struct {
	logPath  string     // æ—¥å¿—æ–‡ä»¶å­˜å‚¨è·¯å¾„
	file     *os.File   // æ™®é€šæ—¥å¿—æ–‡ä»¶å¥æŸ„
	errFile  *os.File   // é”™è¯¯æ—¥å¿—æ–‡ä»¶å¥æŸ„
	fileDate string     // å½“å‰æ—¥å¿—æ–‡ä»¶æ—¥æœŸï¼ˆç”¨äºæŒ‰æ—¥æœŸåˆ†å‰²ï¼‰
	mu       sync.Mutex // äº’æ–¥é”ï¼Œä¿è¯å¹¶å‘å®‰å…¨
}

// ANSIé¢œè‰²ä»£ç å¸¸é‡
// ç”¨äºåœ¨æ§åˆ¶å°è¾“å‡ºå½©è‰²æ—¥å¿—
const (
	red    = 31 // çº¢è‰² - ç”¨äºé”™è¯¯ã€è‡´å‘½ã€ææ…Œçº§åˆ«
	yellow = 33 // é»„è‰² - ç”¨äºè­¦å‘Šçº§åˆ«
	blue   = 36 // è“è‰² - ç”¨äºä¿¡æ¯çº§åˆ«
	grau   = 37 // ç°è‰² - ç”¨äºè°ƒè¯•ã€è·Ÿè¸ªçº§åˆ«
)

// Format å®ç°logrus.Formatteræ¥å£ï¼Œè‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼
// å‚æ•°:
//   - entry: logrusæ—¥å¿—æ¡ç›®ï¼ŒåŒ…å«æ‰€æœ‰æ—¥å¿—ä¿¡æ¯
// è¿”å›:
//   - []byte: æ ¼å¼åŒ–åçš„æ—¥å¿—å†…å®¹
//   - error: æ ¼å¼åŒ–è¿‡ç¨‹ä¸­çš„é”™è¯¯
func (Mylogger) Format(entry *logrus.Entry) ([]byte, error) {
	// æ ¹æ®æ—¥å¿—çº§åˆ«è®¾ç½®å¯¹åº”çš„é¢œè‰²
	var levelColor int
	switch entry.Level {
	case logrus.DebugLevel, logrus.TraceLevel:
		levelColor = grau // è°ƒè¯•å’Œè·Ÿè¸ªçº§åˆ«ä½¿ç”¨ç°è‰²
	case logrus.InfoLevel:
		levelColor = blue // ä¿¡æ¯çº§åˆ«ä½¿ç”¨è“è‰²
	case logrus.WarnLevel:
		levelColor = yellow // è­¦å‘Šçº§åˆ«ä½¿ç”¨é»„è‰²
	case logrus.ErrorLevel, logrus.FatalLevel, logrus.PanicLevel:
		levelColor = red // é”™è¯¯ã€è‡´å‘½ã€ææ…Œçº§åˆ«ä½¿ç”¨çº¢è‰²
	default:
		levelColor = blue // é»˜è®¤ä½¿ç”¨è“è‰²
	}

	// è·å–æˆ–åˆ›å»ºç¼“å†²åŒº
	var b *bytes.Buffer
	if entry.Buffer != nil {
		b = entry.Buffer
	} else {
		b = &bytes.Buffer{}
	}

	// è‡ªå®šä¹‰æ—¥æœŸæ—¶é—´æ ¼å¼
	timestamp := entry.Time.Format("2006-01-02 15:04:05")

	// æ ¹æ®æ˜¯å¦æœ‰è°ƒç”¨è€…ä¿¡æ¯é€‰æ‹©ä¸åŒçš„æ ¼å¼
	if entry.HasCaller() {
		// è¯¦ç»†æ ¼å¼ï¼šåŒ…å«å‡½æ•°åã€æ–‡ä»¶åå’Œè¡Œå·
		funcVal := entry.Caller.Function
		fileVal := fmt.Sprintf("%s:%d", path.Base(entry.Caller.File), entry.Caller.Line)
		fmt.Fprintf(b, "\x1b[%dm[%s] [%s] %s %s: %s\x1b[0m\n",
			levelColor, timestamp, entry.Level, funcVal, fileVal, entry.Message)
	} else {
		// ç®€åŒ–æ ¼å¼ï¼šåªåŒ…å«æ—¶é—´ã€çº§åˆ«å’Œæ¶ˆæ¯
		fmt.Fprintf(b, "\x1b[%dm[%s] [%s]: %s\x1b[0m\n",
			levelColor, timestamp, entry.Level, entry.Message)
	}

	return b.Bytes(), nil
}

// Fire å®ç°logrus.Hookæ¥å£çš„æ ¸å¿ƒæ–¹æ³•
// å½“æ—¥å¿—äº‹ä»¶è§¦å‘æ—¶ï¼Œæ­¤æ–¹æ³•ä¼šè¢«è°ƒç”¨
// å‚æ•°:
//   - entry: åŒ…å«æ—¥å¿—ä¿¡æ¯çš„æ¡ç›®
// è¿”å›:
//   - error: å¤„ç†è¿‡ç¨‹ä¸­çš„é”™è¯¯
func (hook *MyHook) Fire(entry *logrus.Entry) error {
	// åŠ é”ä¿è¯å¹¶å‘å®‰å…¨
	hook.mu.Lock()
	defer hook.mu.Unlock()

	// è·å–å½“å‰æ—¥æœŸï¼Œç”¨äºæ—¥å¿—æ–‡ä»¶æŒ‰æ—¥æœŸåˆ†å‰²
	timer := entry.Time.Format("2006-01-02")

	// å°†æ—¥å¿—æ¡ç›®æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²
	line, err := entry.String()
	if err != nil {
		return fmt.Errorf("æ—¥å¿—æ ¼å¼åŒ–å¤±è´¥: %v", err)
	}

	// æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼ˆè·¨å¤©æ—¶ï¼‰
	if hook.fileDate != timer {
		if err := hook.rotateFiles(timer); err != nil {
			return err
		}
	}

	// å†™å…¥æ™®é€šæ—¥å¿—æ–‡ä»¶ï¼ˆæ‰€æœ‰çº§åˆ«ï¼‰
	if _, err := hook.file.Write([]byte(line)); err != nil {
		return fmt.Errorf("å†™å…¥infoæ—¥å¿—æ–‡ä»¶å¤±è´¥: %v", err)
	}

	// è­¦å‘Šçº§åˆ«åŠä»¥ä¸Šé¢å¤–å†™å…¥é”™è¯¯æ—¥å¿—æ–‡ä»¶
	if entry.Level >= logrus.WarnLevel {
		if _, err := hook.errFile.Write([]byte(line)); err != nil {
			return fmt.Errorf("å†™å…¥erroræ—¥å¿—æ–‡ä»¶å¤±è´¥: %v", err)
		}
	}

	return nil
}

// rotateFiles æ—¥å¿—æ–‡ä»¶è½®æ¢å‡½æ•°
// æŒ‰æ—¥æœŸåˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼Œå®ç°æ—¥å¿—çš„æŒ‰å¤©åˆ†å‰²
// å‚æ•°:
//   - timer: å½“å‰æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆæ ¼å¼ï¼š2006-01-02ï¼‰
// è¿”å›:
//   - error: è½®æ¢è¿‡ç¨‹ä¸­çš„é”™è¯¯
func (hook *MyHook) rotateFiles(timer string) error {
	// å…³é—­å·²å­˜åœ¨çš„æ—¥å¿—æ–‡ä»¶
	if hook.file != nil {
		if err := hook.file.Close(); err != nil {
			return fmt.Errorf("å…³é—­æ—§æ—¥å¿—æ–‡ä»¶å¤±è´¥: %v", err)
		}
	}
	if hook.errFile != nil {
		if err := hook.errFile.Close(); err != nil {
			return fmt.Errorf("å…³é—­æ—§é”™è¯¯æ—¥å¿—æ–‡ä»¶å¤±è´¥: %v", err)
		}
	}

	// åˆ›å»ºæ—¥æœŸç›®å½•ï¼Œå¦‚ï¼šlogs/2025-09-16/
	dirName := fmt.Sprintf("%s/%s", hook.logPath, timer)
	if err := os.MkdirAll(dirName, os.ModePerm); err != nil {
		return fmt.Errorf("åˆ›å»ºæ—¥å¿—ç›®å½•å¤±è´¥: %v", err)
	}

	// æ„å»ºæ—¥å¿—æ–‡ä»¶è·¯å¾„
	infoFileName := fmt.Sprintf("%s/info.log", dirName) // æ™®é€šæ—¥å¿—æ–‡ä»¶
	errFileName := fmt.Sprintf("%s/error.log", dirName) // é”™è¯¯æ—¥å¿—æ–‡ä»¶

	// åˆ›å»ºæˆ–æ‰“å¼€æ™®é€šæ—¥å¿—æ–‡ä»¶
	var err error
	hook.file, err = os.OpenFile(infoFileName, os.O_WRONLY|os.O_APPEND|os.O_CREATE, 0600)
	if err != nil {
		return fmt.Errorf("åˆ›å»ºæ—¥å¿—æ–‡ä»¶å¤±è´¥: %v", err)
	}

	// åˆ›å»ºæˆ–æ‰“å¼€é”™è¯¯æ—¥å¿—æ–‡ä»¶
	hook.errFile, err = os.OpenFile(errFileName, os.O_WRONLY|os.O_APPEND|os.O_CREATE, 0600)
	if err != nil {
		return fmt.Errorf("åˆ›å»ºé”™è¯¯æ—¥å¿—æ–‡ä»¶å¤±è´¥: %v", err)
	}

	// æ›´æ–°å½“å‰æ—¥æœŸ
	hook.fileDate = timer
	return nil
}

// Levels æŒ‡å®šæ­¤Hookå¤„ç†çš„æ—¥å¿—çº§åˆ«
// è¿”å›æ‰€æœ‰æ—¥å¿—çº§åˆ«ï¼Œè¡¨ç¤ºå¤„ç†æ‰€æœ‰ç±»å‹çš„æ—¥å¿—
// è¿”å›å€¼:
//   - []logrus.Level: åŒ…å«æ‰€æœ‰æ—¥å¿—çº§åˆ«çš„åˆ‡ç‰‡
func (hook *MyHook) Levels() []logrus.Level {
	return logrus.AllLevels
}

// InitLogger åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
// é…ç½®logrusæ—¥å¿—åº“ï¼ŒåŒ…æ‹¬æ ¼å¼ã€è¾“å‡ºã€çº§åˆ«ç­‰è®¾ç½®
// å‚æ•°:
//   - logPath: æ—¥å¿—æ–‡ä»¶å­˜å‚¨è·¯å¾„
func InitLogger(logPath string) {
	// è®¾ç½®è‡ªå®šä¹‰æ ¼å¼å™¨ï¼Œå¤„ç†æ—¥å¿—çš„æ ¼å¼åŒ–è¾“å‡º
	formatter := &Mylogger{}
	logrus.SetFormatter(formatter)

	// å¯ç”¨æ—¥å¿—è°ƒç”¨è€…ä¿¡æ¯ï¼ˆæ˜¾ç¤ºè°ƒç”¨æ—¥å¿—çš„æ–‡ä»¶å’Œè¡Œå·ï¼‰
	logrus.SetReportCaller(true)

	// è®¾ç½®æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°
	logrus.SetOutput(os.Stdout)

	// è®¾ç½®æ—¥å¿—çº§åˆ«ä¸ºDebugï¼Œè®°å½•æ‰€æœ‰çº§åˆ«çš„æ—¥å¿—
	logrus.SetLevel(logrus.DebugLevel)

	// åˆ›å»ºå¹¶æ·»åŠ è‡ªå®šä¹‰Hookï¼Œå¤„ç†æ—¥å¿—æ–‡ä»¶å†™å…¥
	hook := &MyHook{
		logPath: logPath, // æ—¥å¿—æ–‡ä»¶æ ¹ç›®å½•
	}
	logrus.AddHook(hook)
	// è®°å½•æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸçš„æ—¥å¿—
	logrus.Infof("âœ… æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸï¼Œæ—¥å¿—æ–‡ä»¶å­˜å‚¨åœ¨: %s", logPath)
}
```
<mcfile name="logger.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\core\logger.go"></mcfile>

### 5.6 è·¯ç”±ä¸APIæ¨¡å—

é¡¹ç›®ä½¿ç”¨Ginä½œä¸ºWebæ¡†æ¶ï¼Œè·¯ç”±ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå°†ä¸åŒåŠŸèƒ½çš„APIè·¯ç”±åˆ†åˆ«å®šä¹‰åœ¨ä¸åŒæ–‡ä»¶ä¸­ï¼Œä¿æŒä»£ç ç»“æ„æ¸…æ™°ã€‚

#### 5.6.1 è·¯ç”±å…¥å£æ–‡ä»¶

```go
// routes/enter.go
package routes

import (
	"rbacAdmin/global"

	gin "github.com/gin-gonic/gin"
	logrus "github.com/sirupsen/logrus"
)

// Run å¯åŠ¨HTTPæœåŠ¡å™¨å¹¶é…ç½®è·¯ç”±
// åŠŸèƒ½: åˆå§‹åŒ–Ginå¼•æ“ã€è®¾ç½®è¿è¡Œæ¨¡å¼ã€é…ç½®é™æ€æ–‡ä»¶è·¯å¾„ã€æ³¨å†ŒAPIè·¯ç”±
func Run() {
	// è·å–ç³»ç»Ÿé…ç½®
	s := global.Config.System

	// æ ¹æ®é…ç½®è®¾ç½®Ginè¿è¡Œæ¨¡å¼
	gin.SetMode(s.Mode)

	// è°ƒè¯•æ¨¡å¼ä¸‹å¼ºåˆ¶å¼€å¯Ginè°ƒè¯•æ¨¡å¼
	if s.Mode == "debug" {
		gin.SetMode(gin.DebugMode)
	}
	// ç”Ÿäº§æ¨¡å¼ä¸‹å¼ºåˆ¶ä½¿ç”¨å‘å¸ƒæ¨¡å¼
	if s.Mode == "release" {
		gin.SetMode(gin.ReleaseMode)
	}

	// åˆ›å»ºé»˜è®¤çš„Ginå¼•æ“ï¼ˆåŒ…å«Loggerå’ŒRecoveryä¸­é—´ä»¶ï¼‰
	r := gin.Default()

	// é…ç½®é™æ€æ–‡ä»¶æœåŠ¡ï¼Œå…è®¸è®¿é—®ä¸Šä¼ ç›®å½•ä¸­çš„æ–‡ä»¶
	r.Static("/uploads", "./uploads")

	// åˆ›å»ºAPIè·¯ç”±ç»„ï¼Œæ‰€æœ‰APIè¯·æ±‚éƒ½ä»¥/apiå¼€å¤´
	g := r.Group("api")

	// æ³¨å†Œç”¨æˆ·ç›¸å…³è·¯ç”±ï¼ˆç™»å½•ã€æ³¨å†Œï¼‰
	UserRouter(g)

	// æ³¨å†ŒéªŒè¯ç ç›¸å…³è·¯ç”±
	CaptchaRouter(g)

	// æ³¨å†Œé‚®ç®±ç›¸å…³è·¯ç”±
	EmailRouter(g)

	// è®°å½•æœåŠ¡å™¨å¯åŠ¨æ—¥å¿—å¹¶å¼€å§‹ç›‘å¬
	logrus.Infof("åç«¯æœåŠ¡è¿è¡Œåœ¨ %s", s.Addr())
	r.Run(s.Addr()) // å¯åŠ¨HTTPæœåŠ¡å™¨
}
```
<mcfile name="enter.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\routes\enter.go"></mcfile>

#### 5.6.2 ç”¨æˆ·è·¯ç”±æ¨¡å—

```go
// routes/user_router.go
package routes

import (
	"rbacAdmin/api"
	"rbacAdmin/api/user_api"
	"rbacAdmin/middleware"

	gin "github.com/gin-gonic/gin"
)

// UserRouter æ³¨å†Œç”¨æˆ·ç›¸å…³APIè·¯ç”±
// å‚æ•°:
//   - r: Ginè·¯ç”±ç»„æŒ‡é’ˆ
func UserRouter(r *gin.RouterGroup) {
	// åˆ›å»ºå­è·¯ç”±ç»„
	g := r.Group("")
	// è·å–ç”¨æˆ·APIå®ä¾‹
	app := api.App.UserApi
	// æ³¨å†Œç™»å½•è·¯ç”±ï¼Œä½¿ç”¨BindJsonä¸­é—´ä»¶è¿›è¡Œè¯·æ±‚å‚æ•°ç»‘å®š
	g.POST("login", middleware.BindJson[user_api.LogingRequest], (app.LoginView))
	// æ³¨å†Œæ³¨å†Œè·¯ç”±ï¼Œä½¿ç”¨BindJsonä¸­é—´ä»¶è¿›è¡Œè¯·æ±‚å‚æ•°ç»‘å®š
	g.POST("register", middleware.BindJson[user_api.RegisterRequest], (app.RegisterView))
}
```
<mcfile name="user_router.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\routes\user_router.go"></mcfile>

#### 5.6.3 éªŒè¯ç è·¯ç”±æ¨¡å—

```go
// routes/captcha_router.go
package routes

import (
	"rbacAdmin/api/captcha_api"

	gin "github.com/gin-gonic/gin"
)

// CaptchaRouter æ³¨å†ŒéªŒè¯ç ç›¸å…³APIè·¯ç”±
// å‚æ•°:
//   - r: Ginè·¯ç”±ç»„æŒ‡é’ˆ
func CaptchaRouter(r *gin.RouterGroup) {
	// åˆ›å»ºå­è·¯ç”±ç»„
	g := r.Group("")
	// åˆ›å»ºéªŒè¯ç APIå®ä¾‹
	app := captcha_api.CaptchaApi{}
	// æ³¨å†Œç”ŸæˆéªŒè¯ç è·¯ç”±
	g.GET("captcha", app.GenerateCaptchaView)
}
```
<mcfile name="captcha_router.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\routes\captcha_router.go"></mcfile>

#### 5.6.4 é‚®ç®±è·¯ç”±æ¨¡å—

```go
// routes/email_router.go
package routes

import (
	"rbacAdmin/api/email_api"
	"rbacAdmin/middleware"

	gin "github.com/gin-gonic/gin"
)

// EmailRouter æ³¨å†Œé‚®ç®±ç›¸å…³APIè·¯ç”±
// å‚æ•°:
//   - r: Ginè·¯ç”±ç»„æŒ‡é’ˆ
func EmailRouter(r *gin.RouterGroup) {
	// åˆ›å»ºå­è·¯ç”±ç»„
	g := r.Group("")
	// åˆ›å»ºé‚®ç®±APIå®ä¾‹
	app := email_api.EmailApi{}
	// æ³¨å†Œå‘é€é‚®ä»¶è·¯ç”±ï¼Œä½¿ç”¨BindJsonä¸­é—´ä»¶è¿›è¡Œè¯·æ±‚å‚æ•°ç»‘å®š
	g.POST("email/send_email", middleware.BindJson[email_api.SendEmailRequest], app.SendEmailView)
}
```
<mcfile name="email_router.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\routes\email_router.go"></mcfile>

#### 5.6.5 è·¯ç”±ç³»ç»Ÿç‰¹ç‚¹

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šè·¯ç”±æŒ‰åŠŸèƒ½æ¨¡å—åˆ’åˆ†åˆ°ä¸åŒæ–‡ä»¶ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
2. **ä¸­é—´ä»¶æœºåˆ¶**ï¼šä½¿ç”¨è‡ªå®šä¹‰çš„`BindJson`ä¸­é—´ä»¶å®ç°è¯·æ±‚å‚æ•°çš„ç±»å‹å®‰å…¨ç»‘å®š
3. **è¿è¡Œæ¨¡å¼åˆ‡æ¢**ï¼šæ”¯æŒæ ¹æ®é…ç½®åœ¨è°ƒè¯•æ¨¡å¼å’Œå‘å¸ƒæ¨¡å¼ä¹‹é—´åˆ‡æ¢
4. **é™æ€æ–‡ä»¶æœåŠ¡**ï¼šå†…ç½®é™æ€æ–‡ä»¶æœåŠ¡ï¼Œç”¨äºæä¾›ä¸Šä¼ æ–‡ä»¶çš„è®¿é—®
5. **ç»Ÿä¸€APIå‰ç¼€**ï¼šæ‰€æœ‰APIè·¯ç”±éƒ½ä»¥`/api`å¼€å¤´ï¼Œä¾¿äºå‰ç«¯é›†æˆ

### 5.7 è®¤è¯ä¸æˆæƒä¸­é—´ä»¶

é¡¹ç›®é‡‡ç”¨JWT (JSON Web Token) è¿›è¡Œç”¨æˆ·è®¤è¯ï¼Œä½¿ç”¨Casbinå®ç°åŸºäºRBACæ¨¡å‹çš„æƒé™æ§åˆ¶ã€‚è®¤è¯ä¸æˆæƒä¸­é—´ä»¶è´Ÿè´£éªŒè¯ç”¨æˆ·èº«ä»½å’Œæƒé™ï¼Œç¡®ä¿APIå®‰å…¨è®¿é—®ã€‚

#### 5.7.1 JWTé…ç½®å®šä¹‰

```go
// config/jwt.go
package config

// JWT å®šä¹‰JWTé…ç½®ç»“æ„ä½“
// ç”¨äºå­˜å‚¨JWTç›¸å…³çš„é…ç½®ä¿¡æ¯
type JWT struct {
	Secret string `yaml:"secret"` // JWTç­¾åå¯†é’¥
	Expire int    `yaml:"expire"` // ä»¤ç‰Œæœ‰æ•ˆæœŸï¼ˆå•ä½ï¼šå°æ—¶ï¼‰
	Issuer string `yaml:"issuer"` // ä»¤ç‰Œé¢å‘è€…
}
```
<mcfile name="jwt.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\config\jwt.go"></mcfile>

#### 5.7.2 å®Œæ•´é…ç½®ç»“æ„ä½“

```go
// config/enter.go
package config

// Config å…¨å±€é…ç½®ç»“æ„ä½“
// åŒ…å«æ‰€æœ‰ç³»ç»Ÿé…ç½®é¡¹
type Config struct {
	System  SystemConfig `yaml:"system"` // ç³»ç»Ÿé…ç½®
	DB      DB           `yaml:"db"`     // æ•°æ®åº“é…ç½®
	Redis   Redis        `yaml:"redis"`  // Redisé…ç½®
	JWT     JWT          `yaml:"jwt"`    // JWTé…ç½®
	Captcha Captcha      `yaml:"captcha"` // éªŒè¯ç é…ç½®
	Email   Email        `yaml:"email"`  // é‚®ç®±é…ç½®
}
```
<mcfile name="enter.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\config\enter.go"></mcfile>

#### 5.7.3 JWTä»¤ç‰Œç­¾å‘ä¸éªŒè¯

```go
// utils/jwts/enter.go
package jwts

import (
	"errors"
	"rbacAdmin/global"
	"time"

	"github.com/dgrijalva/jwt-go"
)

// ClaimsUserInfo è‡ªå®šä¹‰JWTè½½è·ä¸­çš„ç”¨æˆ·ä¿¡æ¯
// åŒ…å«ç”¨æˆ·IDã€ç”¨æˆ·åå’Œè§’è‰²åˆ—è¡¨
type ClaimsUserInfo struct {
	UserID   uint   `json:"userID"`   // ç”¨æˆ·ID
	Username string `json:"username"` // ç”¨æˆ·å
	RoleList []uint `json:"roleList"` // ç”¨æˆ·è§’è‰²IDåˆ—è¡¨
}

// Claims å®Œæ•´çš„JWTå£°æ˜ç»“æ„ä½“
// ç»§æ‰¿æ ‡å‡†å£°æ˜å¹¶æ·»åŠ è‡ªå®šä¹‰ç”¨æˆ·ä¿¡æ¯
type Claims struct {
	ClaimsUserInfo       // åµŒå…¥ç”¨æˆ·ä¿¡æ¯ç»“æ„ä½“
	jwt.StandardClaims // JWTæ ‡å‡†å£°æ˜ï¼ˆåŒ…å«è¿‡æœŸæ—¶é—´ã€é¢å‘è€…ç­‰ï¼‰
}

// GetToken ç”ŸæˆJWTä»¤ç‰Œ
// å‚æ•°:
//   - info: ç”¨æˆ·ä¿¡æ¯ç»“æ„ä½“
// è¿”å›:
//   - string: ç”Ÿæˆçš„JWTä»¤ç‰Œ
//   - error: ç”Ÿæˆè¿‡ç¨‹ä¸­çš„é”™è¯¯
func GetToken(info ClaimsUserInfo) (string, error) {
	// è·å–JWTé…ç½®
	j := global.Config.JWT
	// åˆ›å»ºå£°æ˜å¯¹è±¡
	cla := Claims{
		ClaimsUserInfo: info,
		StandardClaims: jwt.StandardClaims{
			ExpiresAt: time.Now().Add(time.Hour * time.Duration(j.Expire)).Unix(), // è®¾ç½®è¿‡æœŸæ—¶é—´
			Issuer:    j.Issuer, // è®¾ç½®é¢å‘è€…
		},
	}
	// åˆ›å»ºJWTä»¤ç‰Œå¹¶ä½¿ç”¨HS256ç®—æ³•ç­¾å
	token := jwt.NewWithClaims(jwt.SigningMethodHS256, cla)
	// ä½¿ç”¨å¯†é’¥ç­¾åç”Ÿæˆæœ€ç»ˆä»¤ç‰Œ
	return token.SignedString([]byte(j.Secret))
}

// ParseToken è§£æå’ŒéªŒè¯JWTä»¤ç‰Œ
// å‚æ•°:
//   - tokenString: è¦è§£æçš„JWTä»¤ç‰Œå­—ç¬¦ä¸²
// è¿”å›:
//   - *Claims: è§£æåçš„å£°æ˜å¯¹è±¡ï¼ˆåŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼‰
//   - error: è§£æè¿‡ç¨‹ä¸­çš„é”™è¯¯
func ParseToken(tokenString string) (*Claims, error) {
	// è·å–JWTé…ç½®
	j := global.Config.JWT
	// è§£æä»¤ç‰Œå¹¶éªŒè¯ç­¾å
	token, err := jwt.ParseWithClaims(tokenString, &Claims{}, func(token *jwt.Token) (interface{}, error) {
		// è¿”å›ç­¾åå¯†é’¥
		return []byte(j.Secret), nil
	})
	if err != nil {
		return nil, err
	}
	// ç±»å‹æ–­è¨€å¹¶éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§
	claims, ok := token.Claims.(*Claims)
	if ok && token.Valid {
		// éªŒè¯é¢å‘è€…æ˜¯å¦ä¸€è‡´
		if claims.Issuer != j.Issuer {
			return nil, errors.New("token issuer is not valid")
		}
		return claims, nil
	}
	return nil, errors.New("token is not valid")
}
```
<mcfile name="enter.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\utils\jwts\enter.go"></mcfile>

#### 5.7.4 è®¤è¯ä¸­é—´ä»¶è®¾è®¡

è™½ç„¶å½“å‰é¡¹ç›®ä¸­æœªæ‰¾åˆ°å®Œæ•´çš„è®¤è¯ä¸­é—´ä»¶å®ç°ï¼Œä½†æ ¹æ®ä»£ç ç»“æ„å’Œæœ€ä½³å®è·µï¼Œå»ºè®®çš„è®¤è¯ä¸­é—´ä»¶å®ç°å¦‚ä¸‹ï¼š

```go
// middleware/auth.go (å»ºè®®å®ç°)
package middleware

import (
	"net/http"
	"rbacAdmin/common/resp"
	"rbacAdmin/utils/jwts"

	"github.com/gin-gonic/gin"
)

// Auth è®¤è¯ä¸­é—´ä»¶
// ç”¨äºéªŒè¯JWTä»¤ç‰Œå¹¶æå–ç”¨æˆ·ä¿¡æ¯
func Auth() gin.HandlerFunc {
	return func(c *gin.Context) {
		// ä»è¯·æ±‚å¤´è·å–Authorization
		token := c.GetHeader("Authorization")
		if token == "" {
			resp.FailWithMsg("è¯·å…ˆç™»å½•", c)
			c.Abort()
			return
		}

		// ç§»é™¤Bearerå‰ç¼€
		if len(token) > 7 && token[:7] == "Bearer " {
			token = token[7:]
		}

		// è§£æå’ŒéªŒè¯ä»¤ç‰Œ
		claims, err := jwts.ParseToken(token)
		if err != nil {
			resp.FailWithMsg("ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ", c)
			c.Abort()
			return
		}

		// å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥è¯·æ±‚ä¸Šä¸‹æ–‡
		c.Set("userID", claims.UserID)
		c.Set("username", claims.Username)
		c.Set("roleList", claims.RoleList)
		c.Next()
	}
}

// CasbinAuth åŸºäºCasbinçš„æƒé™éªŒè¯ä¸­é—´ä»¶
// ç”¨äºéªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®ç‰¹å®šèµ„æº
func CasbinAuth(obj string, act string) gin.HandlerFunc {
	return func(c *gin.Context) {
		// ä»ä¸Šä¸‹æ–‡è·å–ç”¨æˆ·ID
		userID, exists := c.Get("userID")
		if !exists {
			resp.FailWithMsg("æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯", c)
			c.Abort()
			return
		}

		// è½¬æ¢ç”¨æˆ·IDä¸ºå­—ç¬¦ä¸²æ ¼å¼
		userIDStr := fmt.Sprintf("%v", userID)

		// æ£€æŸ¥æƒé™
		hasPermission, err := global.Casbin.Enforce(userIDStr, obj, act)
		if err != nil || !hasPermission {
			resp.FailWithMsg("æƒé™ä¸è¶³", c)
			c.Abort()
			return
		}

		c.Next()
	}
}
```

#### 5.7.5 è¯·æ±‚å‚æ•°ç»‘å®šä¸­é—´ä»¶

é¡¹ç›®å·²å®ç°çš„å‚æ•°ç»‘å®šä¸­é—´ä»¶ï¼Œç”¨äºå®‰å…¨åœ°è§£æå’ŒéªŒè¯è¯·æ±‚å‚æ•°ï¼š

```go
// middleware/band_middleware.go
package middleware

import (
	"rbacAdmin/common/resp"

	"github.com/gin-gonic/gin"
)

// BindJson ç±»å‹å®‰å…¨çš„JSONè¯·æ±‚å‚æ•°ç»‘å®šä¸­é—´ä»¶
// æ³›å‹å‡½æ•°ï¼Œé€‚ç”¨äºä»»ä½•è¯·æ±‚ä½“ç»“æ„ä½“
func BindJson[T any](c *gin.Context) {
	var cr T
	err := c.ShouldBindJSON(&cr)
	if err != nil {
		// å‚æ•°ç»‘å®šå¤±è´¥æ—¶è¿”å›é”™è¯¯
		resp.FailWithBindingError(err, c)
		c.Abort() // ä¸­æ–­è¯·æ±‚å¤„ç†
		return
	}

	// å°†ç»‘å®šçš„å‚æ•°å­˜å‚¨åˆ°ä¸Šä¸‹æ–‡ä¸­
	c.Set("request", cr)
	return
}

// BindQuery ç±»å‹å®‰å…¨çš„URLæŸ¥è¯¢å‚æ•°ç»‘å®šä¸­é—´ä»¶
// æ³›å‹å‡½æ•°ï¼Œé€‚ç”¨äºä»»ä½•æŸ¥è¯¢å‚æ•°ç»“æ„ä½“
func BindQuery[T any](c *gin.Context) {
	var cr T
	err := c.ShouldBindQuery(&cr)
	if err != nil {
		// å‚æ•°ç»‘å®šå¤±è´¥æ—¶è¿”å›é”™è¯¯
		resp.FailWithBindingError(err, c)
		c.Abort() // ä¸­æ–­è¯·æ±‚å¤„ç†
		return
	}

	// å°†ç»‘å®šçš„å‚æ•°å­˜å‚¨åˆ°ä¸Šä¸‹æ–‡ä¸­
	c.Set("request", cr)
	return
}

// GetBind ä»ä¸Šä¸‹æ–‡ä¸­è·å–ç»‘å®šçš„è¯·æ±‚å‚æ•°
// æ³›å‹å‡½æ•°ï¼Œè¿”å›æŒ‡å®šç±»å‹çš„è¯·æ±‚å‚æ•°
func GetBind[T any](c *gin.Context) (data T) {
	return c.MustGet("request").(T)
}
```
<mcfile name="band_middleware.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\middleware\band_middleware.go"></mcfile>

#### 5.7.6 è®¤è¯ä¸æˆæƒæµç¨‹

1. **ç”¨æˆ·ç™»å½•æµç¨‹**:
   - ç”¨æˆ·æä¾›ç”¨æˆ·åå’Œå¯†ç 
   - ç³»ç»ŸéªŒè¯å‡­è¯å¹¶ç”ŸæˆJWTä»¤ç‰Œ
   - ä»¤ç‰ŒåŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œè¿‡æœŸæ—¶é—´

2. **APIè®¿é—®æµç¨‹**:
   - å®¢æˆ·ç«¯è¯·æ±‚ä¸­åŒ…å«JWTä»¤ç‰Œï¼ˆé€šå¸¸åœ¨Authorizationå¤´ä¸­ï¼‰
   - è®¤è¯ä¸­é—´ä»¶éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§
   - æƒé™ä¸­é—´ä»¶æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®ç‰¹å®šèµ„æº
   - éªŒè¯é€šè¿‡åå…è®¸è®¿é—®API

3. **ä»¤ç‰Œåˆ·æ–°æœºåˆ¶**:
   - ä»¤ç‰Œæ¥è¿‘è¿‡æœŸæ—¶ï¼Œå®¢æˆ·ç«¯å¯ä½¿ç”¨æœ‰æ•ˆä»¤ç‰Œè·å–æ–°ä»¤ç‰Œ
   - é¿å…ç”¨æˆ·é¢‘ç¹é‡æ–°ç™»å½•

### 5.8 é¡¹ç›®å¯åŠ¨ä¸åˆå§‹åŒ–æµç¨‹

é¡¹ç›®å¯åŠ¨ä¸åˆå§‹åŒ–æµç¨‹è´Ÿè´£ä¾æ¬¡åˆå§‹åŒ–å„ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚ä»¥ä¸‹æ˜¯ä¸¤ä¸ªä¸»è¦ç‰ˆæœ¬çš„å¯åŠ¨æµç¨‹å®ç°ï¼š

#### 5.8.1 ç‰ˆæœ¬ä¸€ï¼šrbacAdmin/main.go å¯åŠ¨æµç¨‹

```go
package main

import (
	"rbacAdmin/core"
	"rbacAdmin/flags"
	"rbacAdmin/global"
	"rbacAdmin/utils/captcha"
	route "rbacAdmin/routes"
)

func main() {
	core.InitLogger("logs")           // åˆå§‹åŒ–æ—¥å¿—
	global.Config = core.ReadConfig() // è¯»å–é…ç½®
	global.DB = core.InitGorm()       // åˆå§‹åŒ–æ•°æ®åº“
	global.Casbin = core.InitCasbin() // åˆå§‹åŒ–casbin
	global.Redis = core.InitRedis()   // åˆå§‹åŒ–redis

	// å¯åŠ¨é‚®ä»¶éªŒè¯ç æ¸…ç†å®šæ—¶å™¨
	captcha.EmailStore.StartCleanupTimer()

	flags.Run() // è¿è¡Œåº”ç”¨
	route.Run() // è¿è¡Œè·¯ç”±
}
```
<mcfile name="main.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\main.go"></mcfile>

#### 5.8.2 ç‰ˆæœ¬äºŒï¼šrbac_admin_server/main.go å¯åŠ¨æµç¨‹

```go
package main

import (
	"flag"
	"os"
	"os/signal"
	"syscall"

	"rbac_admin_server/core"
	"rbac_admin_server/global"
	"rbac_admin_server/routes"

	"github.com/sirupsen/logrus"
)

// å‘½ä»¤è¡Œå‚æ•°å®šä¹‰
var (
	configFile = flag.String("settings", "settings.yaml", "é…ç½®æ–‡ä»¶è·¯å¾„")
)

func main() {
	flag.Parse()

	// åŠ è½½é…ç½®
	global.Config = core.ReadConfig(*configFile)

	// åˆå§‹åŒ–æ—¥å¿—
	if err := core.InitLogger(&global.Config.Log); err != nil {
		logrus.Fatalf("âŒ æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: %v", err)
	}

	// åˆå§‹åŒ–ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶
	if err := core.InitSystem(); err != nil {
		global.Logger.Fatalf("âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: %v", err)
	}

	// å¯åŠ¨åº”ç”¨
	routes.Run()

	// ç­‰å¾…ç³»ç»Ÿä¿¡å·ï¼Œä¼˜é›…é€€å‡º
	sigChan := make(chan os.Signal, 1)
	signal.Notify(sigChan, syscall.SIGINT, syscall.SIGTERM)
	<-sigChan

	// æ¸…ç†ç³»ç»Ÿèµ„æº
	core.CleanupSystem()

	logrus.Info("âœ… æœåŠ¡å·²ä¼˜é›…åœæ­¢")
}
```
<mcfile name="main.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbac_admin_server\main.go"></mcfile>

#### 5.8.3 æ ¸å¿ƒç»„ä»¶åˆå§‹åŒ–æµç¨‹

```go
package core

import (
	"fmt"
	"os"
	"os/signal"
	"syscall"

	"rbac_admin_server/core/init_casbin"
	"rbac_admin_server/core/init_gorm"
	"rbac_admin_server/core/init_redis"
	"rbac_admin_server/global"
)

// InitSystem åˆå§‹åŒ–ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶
// æŒ‰é¡ºåºåˆå§‹åŒ–ï¼šéªŒè¯å™¨ -> æ•°æ®åº“ -> Redis -> æ•°æ®åº“è¡¨è¿ç§» -> Casbinæƒé™ç®¡ç†
func InitSystem() error {
	global.Logger.Info("å¼€å§‹åˆå§‹åŒ–ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶...")

	// 1. åˆå§‹åŒ–éªŒè¯å™¨
	if err := InitValidator(); err != nil {
		return fmt.Errorf("åˆå§‹åŒ–éªŒè¯å™¨å¤±è´¥: %v", err)
	}
	global.Logger.Info("âœ… éªŒè¯å™¨åˆå§‹åŒ–æˆåŠŸ")

	// 2. åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
	db, err := init_gorm.InitGorm()
	if err != nil {
		return fmt.Errorf("åˆå§‹åŒ–æ•°æ®åº“å¤±è´¥: %v", err)
	}
	global.DB = db
	global.Logger.Info("âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ")

	// 3. åˆå§‹åŒ–Redisç¼“å­˜
	redisClient, err := init_redis.InitRedis()
	if err != nil {
		global.Logger.Warnf("âš ï¸ Redisåˆå§‹åŒ–å¤±è´¥: %v, å°†ç»§ç»­è¿è¡Œ", err)
	} else {
		global.Redis = redisClient
		global.Logger.Info("âœ… Redisåˆå§‹åŒ–æˆåŠŸ")
	}

	// 4. è‡ªåŠ¨è¿ç§»æ•°æ®åº“è¡¨ç»“æ„
	if err := AutoMigrateModels(); err != nil {
		return fmt.Errorf("è‡ªåŠ¨è¿ç§»æ•°æ®åº“è¡¨ç»“æ„å¤±è´¥: %v", err)
	}
	global.Logger.Info("âœ… æ•°æ®åº“è¡¨ç»“æ„è‡ªåŠ¨è¿ç§»æˆåŠŸ")

	// 5. åˆå§‹åŒ–Casbinæƒé™ç®¡ç†
	casbinEnforcer, err := init_casbin.InitCasbin()
	if err != nil {
		global.Logger.Warnf("âš ï¸ Casbinæƒé™ç®¡ç†åˆå§‹åŒ–å¤±è´¥: %v, å°†ç»§ç»­è¿è¡Œ", err)
	} else {
		global.Casbin = casbinEnforcer
		global.Logger.Info("âœ… Casbinæƒé™ç®¡ç†åˆå§‹åŒ–æˆåŠŸ")
	}

	global.Logger.Info("ğŸ‰ ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶åˆå§‹åŒ–å®Œæˆ")
	return nil
}
```
<mcfile name="init.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbac_admin_server\core\init.go"></mcfile>

#### 5.8.4 ç³»ç»Ÿèµ„æºæ¸…ç†ä¸ä¼˜é›…é€€å‡º

```go
// CleanupSystem æ¸…ç†ç³»ç»Ÿèµ„æº
func CleanupSystem() {
	global.Logger.Info("å¼€å§‹æ¸…ç†ç³»ç»Ÿèµ„æº...")

	// å…³é—­æ•°æ®åº“è¿æ¥
	if err := CloseDB(); err != nil {
		global.Logger.Errorf("å…³é—­æ•°æ®åº“è¿æ¥å¤±è´¥: %v", err)
	} else {
		global.Logger.Info("âœ… æ•°æ®åº“è¿æ¥å·²å…³é—­")
	}

	// å…³é—­Redisè¿æ¥
	if err := CloseRedis(); err != nil {
		global.Logger.Errorf("å…³é—­Redisè¿æ¥å¤±è´¥: %v", err)
	} else {
		global.Logger.Info("âœ… Redisè¿æ¥å·²å…³é—­")
	}

	global.Logger.Info("âœ… ç³»ç»Ÿèµ„æºæ¸…ç†å®Œæˆ")
}
```
<mcfile name="init.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbac_admin_server\core\init.go"></mcfile>

#### 5.8.5 åˆå§‹åŒ–æµç¨‹æ€»ç»“

é¡¹ç›®å¯åŠ¨çš„å®Œæ•´æµç¨‹å¯ä»¥æ€»ç»“ä¸ºä»¥ä¸‹å‡ ä¸ªä¸»è¦æ­¥éª¤ï¼š

1. **å‘½ä»¤è¡Œå‚æ•°è§£æ**:
   - è§£æé…ç½®æ–‡ä»¶è·¯å¾„ç­‰å‘½ä»¤è¡Œå‚æ•°ï¼ˆä¼˜åŒ–ç‰ˆå®ç°ï¼‰

2. **é…ç½®åŠ è½½**:
   - è¯»å–ç³»ç»Ÿé…ç½®æ–‡ä»¶ï¼Œåˆå§‹åŒ–å…¨å±€é…ç½®å¯¹è±¡

3. **æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–**:
   - é…ç½®æ—¥å¿—çº§åˆ«ã€æ ¼å¼ã€è¾“å‡ºä½ç½®ç­‰
   - ä¸ºåç»­ç³»ç»Ÿç»„ä»¶æä¾›æ—¥å¿—è®°å½•åŠŸèƒ½

4. **æ ¸å¿ƒç»„ä»¶åˆå§‹åŒ–** (æŒ‰é¡ºåº):
   - éªŒè¯å™¨ï¼šç”¨äºè¯·æ±‚å‚æ•°éªŒè¯å’Œæ•°æ®æ ¡éªŒ
   - æ•°æ®åº“ï¼šå»ºç«‹æ•°æ®åº“è¿æ¥ï¼Œæ”¯æŒMySQLã€PostgreSQLã€SQLiteç­‰å¤šç§æ•°æ®åº“
   - Redisç¼“å­˜ï¼šåˆå§‹åŒ–Rediså®¢æˆ·ç«¯ï¼Œç”¨äºç¼“å­˜ä¼šè¯æ•°æ®ã€éªŒè¯ç ç­‰
   - æ•°æ®åº“è¡¨è¿ç§»ï¼šè‡ªåŠ¨åˆ›å»ºæˆ–æ›´æ–°æ•°æ®åº“è¡¨ç»“æ„
   - æƒé™ç®¡ç†ï¼šåˆå§‹åŒ–Casbinæƒé™æ§åˆ¶ç»„ä»¶ï¼ŒåŠ è½½æƒé™ç­–ç•¥

5. **ä¸šåŠ¡ç»„ä»¶åˆå§‹åŒ–**:
   - é‚®ä»¶éªŒè¯ç æ¸…ç†å®šæ—¶å™¨ï¼šå®šæœŸæ¸…ç†è¿‡æœŸçš„éªŒè¯ç 
   - APIæ¨¡å—åˆå§‹åŒ–ï¼šæ³¨å†Œæ‰€æœ‰APIæ§åˆ¶å™¨

6. **å¯åŠ¨WebæœåŠ¡**:
   - åˆå§‹åŒ–è·¯ç”±ç³»ç»Ÿ
   - å¯åŠ¨HTTPæœåŠ¡ï¼Œç›‘å¬æŒ‡å®šç«¯å£

7. **ä¿¡å·ç›‘å¬ä¸ä¼˜é›…é€€å‡º**:
   - ç›‘å¬ç³»ç»Ÿä¿¡å·ï¼ˆSIGINTã€SIGTERMï¼‰
   - æ¥æ”¶åˆ°ç»ˆæ­¢ä¿¡å·æ—¶ï¼Œæ¸…ç†ç³»ç»Ÿèµ„æºå¹¶å®‰å…¨é€€å‡º

#### 5.8.6 å¯åŠ¨å‘½ä»¤

å¼€å‘ç¯å¢ƒå¯åŠ¨å‘½ä»¤ï¼š

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®å¯åŠ¨
go run main.go

# æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„å¯åŠ¨
go run main.go --settings=config.yaml
```

ç”Ÿäº§ç¯å¢ƒå¯åŠ¨å‘½ä»¤ï¼š

```bash
# ç¼–è¯‘æ„å»º
CGO_ENABLED=0 go build -o rbacAdmin .

# è¿è¡Œç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶
./rbacAdmin --settings=settings.yaml

# ä½¿ç”¨nohupåœ¨åå°è¿è¡Œ
nohup ./rbacAdmin --settings=settings.yaml > app.log 2>&1 &
```

### 5.9 é¡¹ç›®ç»“æ„æ€»ç»“

é¡¹ç›®é‡‡ç”¨æ¸…æ™°çš„åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„é¡¹ç›®ç»“æ„å’Œå„æ¨¡å—åŠŸèƒ½è¯´æ˜ï¼š

```
rbacAdmin/
â”œâ”€â”€ api/                 # APIæ§åˆ¶å™¨å±‚ï¼Œå¤„ç†è¯·æ±‚å’Œå“åº”
â”‚   â”œâ”€â”€ captcha_api/     # éªŒè¯ç ç›¸å…³API
â”‚   â”œâ”€â”€ email_api/       # é‚®ç®±ç›¸å…³API
â”‚   â”œâ”€â”€ user_api/        # ç”¨æˆ·ç›¸å…³APIï¼ˆç™»å½•ã€æ³¨å†Œç­‰ï¼‰
â”‚   â””â”€â”€ enter.go         # APIå…¥å£æ–‡ä»¶
â”œâ”€â”€ cmd/                 # å‘½ä»¤è¡Œå·¥å…·å’Œæµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ jwt_test/        # JWTæµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ å›¾ç‰‡éªŒè¯ç .go     # éªŒè¯ç æµ‹è¯•
â”‚   â”œâ”€â”€ å¯†ç hash.go      # å¯†ç å“ˆå¸Œæµ‹è¯•
â”‚   â””â”€â”€ é‚®ç®±.go          # é‚®ç®±æµ‹è¯•
â”œâ”€â”€ common/              # é€šç”¨ç»„ä»¶
â”‚   â””â”€â”€ resp/            # å“åº”å¤„ç†å·¥å…·
â”œâ”€â”€ config/              # é…ç½®ç»“æ„å®šä¹‰
â”‚   â”œâ”€â”€ captcha.go       # éªŒè¯ç é…ç½®
â”‚   â”œâ”€â”€ db.go            # æ•°æ®åº“é…ç½®
â”‚   â”œâ”€â”€ email.go         # é‚®ç®±é…ç½®
â”‚   â”œâ”€â”€ enter.go         # ä¸»é…ç½®ç»“æ„
â”‚   â”œâ”€â”€ jwt.go           # JWTé…ç½®
â”‚   â”œâ”€â”€ redis.go         # Redisé…ç½®
â”‚   â””â”€â”€ system.go        # ç³»ç»Ÿé…ç½®
â”œâ”€â”€ core/                # æ ¸å¿ƒåŠŸèƒ½å®ç°
â”‚   â”œâ”€â”€ casbin.go        # Casbinæƒé™ç®¡ç†
â”‚   â”œâ”€â”€ db.go            # æ•°æ®åº“è¿æ¥å’Œæ“ä½œ
â”‚   â”œâ”€â”€ logger.go        # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”œâ”€â”€ read_config.go   # é…ç½®è¯»å–
â”‚   â”œâ”€â”€ redis.go         # Redisæ“ä½œ
â”‚   â””â”€â”€ set_config.go    # é…ç½®è®¾ç½®
â”œâ”€â”€ flags/               # å‘½ä»¤è¡Œå‚æ•°å¤„ç†
â”œâ”€â”€ global/              # å…¨å±€å˜é‡å’Œå¯¹è±¡
â”œâ”€â”€ middleware/          # ä¸­é—´ä»¶
â”œâ”€â”€ models/              # æ•°æ®æ¨¡å‹
â”œâ”€â”€ routes/              # è·¯ç”±é…ç½®
â”œâ”€â”€ service/             # ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°
â”œâ”€â”€ uploads/             # ä¸Šä¼ æ–‡ä»¶å­˜å‚¨ç›®å½•
â”œâ”€â”€ logs/                # æ—¥å¿—æ–‡ä»¶å­˜å‚¨ç›®å½•
â”œâ”€â”€ main.go              # é¡¹ç›®ä¸»å…¥å£
â”œâ”€â”€ go.mod               # Goæ¨¡å—å®šä¹‰
â”œâ”€â”€ go.sum               # ä¾èµ–ç‰ˆæœ¬é”å®š
â”œâ”€â”€ settings.yaml        # é…ç½®æ–‡ä»¶
â”œâ”€â”€ settings.yaml.example # é…ç½®æ–‡ä»¶ç¤ºä¾‹
â””â”€â”€ README.md            # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

#### 5.9.1 ç›®å½•ç»“æ„è¯´æ˜

1. **api/**: 
   - åŒ…å«æ‰€æœ‰APIæ§åˆ¶å™¨ï¼Œè´Ÿè´£å¤„ç†HTTPè¯·æ±‚å¹¶è¿”å›å“åº”
   - æŒ‰ç…§åŠŸèƒ½æ¨¡å—è¿›è¡Œåˆ’åˆ†ï¼Œå¦‚ç”¨æˆ·ã€éªŒè¯ç ã€é‚®ç®±ç­‰
   - æ§åˆ¶å™¨é€šè¿‡è°ƒç”¨serviceå±‚å®ç°ä¸šåŠ¡é€»è¾‘

2. **cmd/**: 
   - åŒ…å«å„ç§å‘½ä»¤è¡Œå·¥å…·å’Œæµ‹è¯•è„šæœ¬
   - ç”¨äºå¼€å‘è¿‡ç¨‹ä¸­çš„åŠŸèƒ½æµ‹è¯•å’Œè°ƒè¯•

3. **common/**: 
   - å­˜æ”¾é€šç”¨ç»„ä»¶ï¼Œå¦‚å“åº”å¤„ç†ã€é”™è¯¯å¤„ç†ç­‰
   - æä¾›è·¨æ¨¡å—å…±äº«çš„åŠŸèƒ½

4. **config/**: 
   - å®šä¹‰æ‰€æœ‰é…ç½®é¡¹çš„ç»“æ„ä½“
   - åŒ…å«æ•°æ®åº“ã€Redisã€JWTã€é‚®ç®±ç­‰å„ç»„ä»¶çš„é…ç½®ç»“æ„

5. **core/**: 
   - æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼ŒåŒ…æ‹¬æ—¥å¿—ã€æ•°æ®åº“ã€Redisç­‰åŸºç¡€è®¾æ–½
   - æä¾›ç³»ç»Ÿè¿è¡Œæ‰€éœ€çš„åŸºç¡€æœåŠ¡

6. **middleware/**: 
   - ä¸­é—´ä»¶å®ç°ï¼Œå¦‚å‚æ•°ç»‘å®šã€è®¤è¯æˆæƒç­‰
   - ç”¨äºæ‹¦æˆªå’Œå¤„ç†è¯·æ±‚

7. **models/**: 
   - æ•°æ®æ¨¡å‹å®šä¹‰ï¼Œå¯¹åº”æ•°æ®åº“è¡¨ç»“æ„
   - å®ç°æ•°æ®çš„æŒä¹…åŒ–å­˜å‚¨

8. **routes/**: 
   - è·¯ç”±é…ç½®ï¼Œå®šä¹‰APIç«¯ç‚¹å’Œå¯¹åº”çš„å¤„ç†å‡½æ•°
   - å®ç°æ¨¡å—åŒ–çš„è·¯ç”±ç®¡ç†

9. **service/**: 
   - ä¸šåŠ¡é€»è¾‘å±‚ï¼Œå®ç°æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½
   - è¿æ¥æ§åˆ¶å™¨å’Œæ•°æ®æ¨¡å‹

10. **utils/**: 
    - å·¥å…·å‡½æ•°é›†åˆï¼Œæä¾›å„ç§è¾…åŠ©åŠŸèƒ½
    - å¦‚JWTä»¤ç‰Œç”Ÿæˆã€éªŒè¯ç­‰

#### 5.9.2 æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

1. **è®¤è¯ä¸æˆæƒ**: 
   - åŸºäºJWTçš„ç”¨æˆ·è®¤è¯
   - åŸºäºCasbinçš„RBACæƒé™æ§åˆ¶
   - æ”¯æŒç»†ç²’åº¦çš„æƒé™ç®¡ç†

2. **ç”¨æˆ·ç®¡ç†**: 
   - ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æ³¨é”€
   - ç”¨æˆ·ä¿¡æ¯ç®¡ç†
   - å¯†ç é‡ç½®å’Œå®‰å…¨è®¾ç½®

3. **éªŒè¯ç æœåŠ¡**: 
   - å›¾ç‰‡éªŒè¯ç ç”Ÿæˆå’ŒéªŒè¯
   - é‚®ç®±éªŒè¯ç å‘é€å’ŒéªŒè¯
   - æ”¯æŒå¤šç§éªŒè¯ç ç±»å‹

4. **æ–‡ä»¶ç®¡ç†**: 
   - æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½
   - æ–‡ä»¶å­˜å‚¨å’Œè®¿é—®æ§åˆ¶
   - æ”¯æŒå¤šç§å­˜å‚¨æ–¹å¼

5. **æ—¥å¿—ç³»ç»Ÿ**: 
   - åº”ç”¨æ—¥å¿—è®°å½•
   - æŒ‰æ—¥æœŸå’Œçº§åˆ«åˆ†å‰²æ—¥å¿—
   - æ”¯æŒæ§åˆ¶å°å’Œæ–‡ä»¶è¾“å‡º

6. **é…ç½®ç®¡ç†**: 
   - å¤šç¯å¢ƒé…ç½®æ”¯æŒ
   - é…ç½®çƒ­åŠ è½½
   - é…ç½®é¡¹éªŒè¯

#### 5.9.3 æŠ€æœ¯æ ˆæ€»ç»“

| æŠ€æœ¯/æ¡†æ¶              | ç”¨é€”                           | ç‰ˆæœ¬        |
|----------------------|--------------------------------|-------------|
| Go                   | ä¸»è¦å¼€å‘è¯­è¨€                     | 1.xx+       |
| Gin                  | Webæ¡†æ¶                         | æœ€æ–°ç‰ˆ       |
| GORM                 | ORMæ¡†æ¶ï¼Œæ•°æ®åº“æ“ä½œ               | æœ€æ–°ç‰ˆ       |
| Redis                | ç¼“å­˜å­˜å‚¨ï¼Œä¼šè¯ç®¡ç†                | 5.x+        |
| MySQL/PostgreSQL/SQLite | æ•°æ®åº“å­˜å‚¨                    | å¤šç§æ”¯æŒ      |
| JWT                  | ç”¨æˆ·è®¤è¯                        | github.com/dgrijalva/jwt-go |
| Casbin               | æƒé™ç®¡ç†                        | github.com/casbin/casbin |
| Logrus               | æ—¥å¿—ç³»ç»Ÿ                        | github.com/sirupsen/logrus |
| Swagger              | APIæ–‡æ¡£ï¼ˆæ¨æµ‹æ”¯æŒï¼‰               | æœ€æ–°ç‰ˆ       |

#### 5.9.4 é¡¹ç›®æ¶æ„ç‰¹ç‚¹

1. **æ¨¡å—åŒ–è®¾è®¡**: 
   - åŠŸèƒ½æŒ‰ç…§æ¨¡å—æ¸…æ™°åˆ’åˆ†
   - å„æ¨¡å—é—´ä½è€¦åˆé«˜å†…èš

2. **åˆ†å±‚æ¶æ„**: 
   - APIå±‚: å¤„ç†HTTPè¯·æ±‚
   - Serviceå±‚: å®ç°ä¸šåŠ¡é€»è¾‘
   - Modelå±‚: æ•°æ®æŒä¹…åŒ–
   - Coreå±‚: åŸºç¡€è®¾æ–½å’Œå…¬å…±æœåŠ¡

3. **å¯æ‰©å±•æ€§**: 
   - æ”¯æŒå¤šç§æ•°æ®åº“
   - æ”¯æŒé…ç½®é©±åŠ¨
   - æ˜“äºæ·»åŠ æ–°åŠŸèƒ½æ¨¡å—

4. **å®‰å…¨æ€§**: 
   - å¯†ç åŠ å¯†å­˜å‚¨
   - JWTè®¤è¯æœºåˆ¶
   - ç»†ç²’åº¦çš„æƒé™æ§åˆ¶
   - è¯·æ±‚å‚æ•°éªŒè¯

5. **å¯ç»´æŠ¤æ€§**: 
   - æ¸…æ™°çš„ä»£ç ç»“æ„
   - å®Œå–„çš„æ–‡æ¡£
   - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
   - ç»“æ„åŒ–çš„æ—¥å¿—è®°å½•

### 5.10 éƒ¨ç½²ä¸è¿è¡ŒæŒ‡å—

é¡¹ç›®å¯ä»¥åœ¨å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œï¼Œä»¥ä¸‹æ˜¯è¯¦ç»†çš„éƒ¨ç½²å’Œè¿è¡ŒæŒ‡å—ï¼š

#### 5.10.1 ç¯å¢ƒè¦æ±‚

- Go 1.16+ 
- MySQL/PostgreSQL/SQLite (æ ¹æ®é…ç½®é€‰æ‹©)
- Redis (å¯é€‰ï¼Œç”¨äºç¼“å­˜)

#### 5.10.2 å¼€å‘ç¯å¢ƒè®¾ç½®

1. **å®‰è£…ä¾èµ–**: 
   ```bash
   go mod tidy
   ```

2. **é…ç½®æ–‡ä»¶**: 
   - å¤åˆ¶ `settings.yaml.example` åˆ° `settings.yaml`
   - æ ¹æ®æœ¬åœ°ç¯å¢ƒä¿®æ”¹é…ç½®å‚æ•°

3. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**: 
   ```bash
   go run main.go
   ```

#### 5.10.3 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

1. **ç¼–è¯‘æ„å»º**: 
   ```bash
   # Linux/Mac
   CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o rbacAdmin .
   
   # Windows
   go build -o rbacAdmin.exe .
   ```

2. **éƒ¨ç½²æ–‡ä»¶**: 
   - å¯æ‰§è¡Œæ–‡ä»¶ (rbacAdmin/rbacAdmin.exe)
   - é…ç½®æ–‡ä»¶ (settings.yaml)
   - é™æ€èµ„æº (å¦‚æœ‰)

3. **è¿è¡Œæ–¹å¼**: 
   ```bash
   # ç›´æ¥è¿è¡Œ
   ./rbacAdmin --settings=settings.yaml
   
   # ä½¿ç”¨nohupåœ¨åå°è¿è¡Œ
   nohup ./rbacAdmin --settings=settings.yaml > app.log 2>&1 &
   
   # ä½¿ç”¨systemdç®¡ç†(æ¨è)
   # åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶
   ```

#### 5.10.4 Dockeréƒ¨ç½²

è™½ç„¶é¡¹ç›®ä¸­æœªç›´æ¥æä¾›Dockerç›¸å…³æ–‡ä»¶ï¼Œä½†å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ–¹å¼è¿›è¡ŒDockeréƒ¨ç½²ï¼š

1. **åˆ›å»ºDockerfile**: 
   ```dockerfile
   # ä½¿ç”¨Goå®˜æ–¹é•œåƒä½œä¸ºæ„å»ºç¯å¢ƒ
   FROM golang:1.18-alpine AS builder
   
   # è®¾ç½®å·¥ä½œç›®å½•
   WORKDIR /app
   
   # å¤åˆ¶go.modå’Œgo.sum
   COPY go.mod go.sum ./
   
   # ä¸‹è½½ä¾èµ–
   RUN go mod tidy
   
   # å¤åˆ¶æºä»£ç 
   COPY . .
   
   # ç¼–è¯‘æ„å»º
   RUN CGO_ENABLED=0 GOOS=linux go build -o rbacAdmin .
   
   # ä½¿ç”¨Alpineä½œä¸ºè¿è¡Œç¯å¢ƒ
   FROM alpine:latest
   
   # è®¾ç½®å·¥ä½œç›®å½•
   WORKDIR /app
   
   # å¤åˆ¶ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶
   COPY --from=builder /app/rbacAdmin .
   
   # å¤åˆ¶é…ç½®æ–‡ä»¶
   COPY settings.yaml .
   
   # åˆ›å»ºæ—¥å¿—å’Œä¸Šä¼ ç›®å½•
   RUN mkdir -p logs uploads
   
   # æš´éœ²ç«¯å£
   EXPOSE 8080
   
   # å¯åŠ¨æœåŠ¡
   CMD ["./rbacAdmin", "--settings=settings.yaml"]
   ```

2. **æ„å»ºDockeré•œåƒ**: 
   ```bash
   docker build -t rbacadmin .
   ```

3. **è¿è¡ŒDockerå®¹å™¨**: 
   ```bash
   docker run -d -p 8080:8080 --name rbacadmin rbacadmin
   ```

#### 5.10.5 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

1. **æ•°æ®åº“è¿æ¥å¤±è´¥**: 
   - æ£€æŸ¥æ•°æ®åº“æœåŠ¡æ˜¯å¦è¿è¡Œ
   - éªŒè¯é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®åº“è¿æ¥å‚æ•°æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æ•°æ®åº“ç”¨æˆ·æ˜¯å¦æœ‰è¶³å¤Ÿæƒé™

2. **Redisè¿æ¥å¤±è´¥**: 
   - æ£€æŸ¥RedisæœåŠ¡æ˜¯å¦è¿è¡Œ
   - éªŒè¯Redisè¿æ¥å‚æ•°
   - å¦‚æœä¸éœ€è¦RedisåŠŸèƒ½ï¼Œå¯ä»¥å¿½ç•¥æ­¤é”™è¯¯

3. **ç«¯å£è¢«å ç”¨**: 
   - ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„æœåŠ¡ç«¯å£
   - å…³é—­å ç”¨ç›¸åŒç«¯å£çš„å…¶ä»–ç¨‹åº

4. **æ—¥å¿—æƒé™é—®é¢˜**: 
   - ç¡®ä¿åº”ç”¨æœ‰æ—¥å¿—ç›®å½•çš„å†™å…¥æƒé™
   - æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æƒé™è®¾ç½®

5. **é…ç½®æ–‡ä»¶è¯»å–å¤±è´¥**: 
   - ç¡®è®¤é…ç½®æ–‡ä»¶è·¯å¾„æ­£ç¡®
   - éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼æ˜¯å¦ç¬¦åˆYAMLè§„èŒƒ

#### 5.10.6 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å¯ç”¨Redisç¼“å­˜**: 
   - é…ç½®Redisç¼“å­˜å¯ä»¥æ˜¾è‘—æé«˜ç³»ç»Ÿæ€§èƒ½
   - é€‚ç”¨äºä¼šè¯æ•°æ®ã€éªŒè¯ç ç­‰é¢‘ç¹è®¿é—®çš„æ•°æ®

2. **æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–**: 
   - ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
   - å®šæœŸåˆ†æå’Œä¼˜åŒ–æ•°æ®åº“è¡¨

3. **æ—¥å¿—çº§åˆ«è°ƒæ•´**: 
   - ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨INFOæˆ–WARNçº§åˆ«
   - é¿å…è¿‡å¤šçš„DEBUGæ—¥å¿—å½±å“æ€§èƒ½

4. **è¿æ¥æ± é…ç½®**: 
   - æ ¹æ®ç³»ç»Ÿè´Ÿè½½è°ƒæ•´æ•°æ®åº“è¿æ¥æ± å¤§å°
   - åˆç†è®¾ç½®Redisè¿æ¥æ± å‚æ•°

5. **ä»£ç ä¼˜åŒ–**: 
   - é¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“
   - ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘æ•°æ®åº“äº¤äº’

### 5.11 æ€»ç»“ä¸å±•æœ›

æœ¬é¡¹ç›®æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„RBACæƒé™ç®¡ç†ç³»ç»Ÿæ¡†æ¶ï¼ŒåŒ…å«ç”¨æˆ·è®¤è¯ã€æƒé™æ§åˆ¶ã€APIè·¯ç”±ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚é€šè¿‡æ¨¡å—åŒ–è®¾è®¡å’Œæ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œå®ç°äº†é«˜å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

æœªæ¥å¯ä»¥è€ƒè™‘ä»¥ä¸‹ä¼˜åŒ–æ–¹å‘ï¼š

1. **å®Œå–„APIæ–‡æ¡£**: é›†æˆSwaggerè‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£
2. **å¢åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•**: æé«˜ä»£ç è´¨é‡å’Œç¨³å®šæ€§
3. **æ·»åŠ ç›‘æ§å‘Šè­¦**: å®æ—¶ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€
4. **å®ç°å¾®æœåŠ¡åŒ–**: æ”¯æŒå¤§è§„æ¨¡éƒ¨ç½²å’Œæ°´å¹³æ‰©å±•
5. **å®Œå–„å‰ç«¯ç•Œé¢**: æä¾›å®Œæ•´çš„ç®¡ç†åå°ç•Œé¢

é€šè¿‡æŒç»­ä¼˜åŒ–å’Œè¿­ä»£ï¼Œæœ¬é¡¹ç›®å¯ä»¥æˆä¸ºä¸€ä¸ªåŠŸèƒ½å®Œå–„ã€æ€§èƒ½ä¼˜å¼‚çš„ä¼ä¸šçº§æƒé™ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚

---

**æ–‡æ¡£æ›´æ–°æ—¶é—´**: 2023-xx-xx
**ç‰ˆæœ¬**: 1.0.0
package routes

import (
    "github.com/gin-gonic/gin"
    "rbacAdmin/api"
    "rbacAdmin/global"
)

// Run è¿è¡ŒHTTPæœåŠ¡
func Run() {
    // è®¾ç½®Ginè¿è¡Œæ¨¡å¼
    gin.SetMode(global.Config.System.Mode)
    
    // åˆ›å»ºGinå¼•æ“
    r := gin.Default()
    
    // è®¾ç½®é™æ€æ–‡ä»¶ç›®å½•
    r.Static("/static", "./static")
    
    // APIè·¯ç”±ç»„
    api := r.Group("/api")
    {
        // æ³¨å†Œç”¨æˆ·è·¯ç”±
        user := api.Group("/user")
        {
            user.POST("/login", api.UserApi.Login)
            user.POST("/register", api.UserApi.Register)
            // ...æ›´å¤šç”¨æˆ·è·¯ç”±
        }
        
        // æ³¨å†ŒéªŒè¯ç è·¯ç”±
        captcha := api.Group("/captcha")
        {
            captcha.GET("/get", api.CaptchaApi.GetCaptcha)
            // ...æ›´å¤šéªŒè¯ç è·¯ç”±
        }
        
        // æ³¨å†Œé‚®ç®±è·¯ç”±
        email := api.Group("/email")
        {
            email.POST("/send", api.EmailApi.SendEmail)
            // ...æ›´å¤šé‚®ç®±è·¯ç”±
        }
    }
    
    // å¯åŠ¨æœåŠ¡
    addr := fmt.Sprintf("%s:%d", global.Config.System.Host, global.Config.System.Port)
    r.Run(addr)
}
```
<mcfile name="enter.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\routes\enter.go"></mcfile>

### 5.6 ç”¨æˆ·è®¤è¯æ¨¡å—

```go
// api/user_api/login.go
package user_api

import (
    "github.com/gin-gonic/gin"
    "github.com/golang-jwt/jwt/v5"
    "golang.org/x/crypto/bcrypt"
    "rbacAdmin/common/resp"
    "rbacAdmin/global"
    "time"
)

// LoginRequest ç™»å½•è¯·æ±‚ç»“æ„ä½“
type LoginRequest struct {
    Username string `json:"username" binding:"required"`
    Password string `json:"password" binding:"required"`
    Captcha  string `json:"captcha" binding:"required"`
    CaptchaID string `json:"captcha_id" binding:"required"`
}

// Login å¤„ç†ç”¨æˆ·ç™»å½•
func (u *UserApi) Login(c *gin.Context) {
    var req LoginRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        resp.FailWithMsg("å‚æ•°éªŒè¯å¤±è´¥", c)
        return
    }
    
    // éªŒè¯ç æ ¡éªŒ
    if !checkCaptcha(req.CaptchaID, req.Captcha) {
        resp.FailWithMsg("éªŒè¯ç é”™è¯¯", c)
        return
    }
    
    // ç”¨æˆ·è®¤è¯é€»è¾‘
    var user models.User
    if err := global.DB.Where("username = ?", req.Username).First(&user).Error; err != nil {
        resp.FailWithMsg("ç”¨æˆ·åä¸å­˜åœ¨", c)
        return
    }
    
    // å¯†ç éªŒè¯
    if err := bcrypt.CompareHashAndPassword([]byte(user.Password), []byte(req.Password)); err != nil {
        resp.FailWithMsg("å¯†ç é”™è¯¯", c)
        return
    }
    
    // ç”ŸæˆJWTä»¤ç‰Œ
    claims := jwt.MapClaims{
        "id":       user.ID,
        "username": user.Username,
        "exp":      time.Now().Add(time.Hour * 24).Unix(),
    }
    token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)
    tokenString, _ := token.SignedString([]byte(global.Config.JWT.Secret))
    
    resp.OkWithData(map[string]string{"token": tokenString}, c)
}
```
<mcfile name="login.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\api\user_api\login.go"></mcfile>

## 6. æ•°æ®æ¨¡å‹

### 6.1 ç”¨æˆ·æ¨¡å‹

```go
// models/enter.go
package models

import (
    "gorm.io/gorm"
)

// UserModel ç”¨æˆ·æ¨¡å‹
type UserModel struct {
    gorm.Model
    Username    string     `gorm:"size:50;uniqueIndex" json:"username"`
    Nickname    string     `gorm:"size:50" json:"nickname"`
    Avatar      string     `json:"avatar"`
    Email       string     `gorm:"size:100;uniqueIndex" json:"email"`
    Password    string     `gorm:"size:100" json:"password"`
    IsAdmin     bool       `gorm:"default:false" json:"is_admin"`
    Roles       []Role     `gorm:"many2many:user_roles" json:"roles"`
}

// UserRoleModel ç”¨æˆ·è§’è‰²å…³è”æ¨¡å‹
type UserRoleModel struct {
    UserID uint `gorm:"primaryKey"`
    RoleID uint `gorm:"primaryKey"`
}
```
<mcfile name="enter.go" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\models\enter.go"></mcfile>

## 7. é…ç½®æ–‡ä»¶è¯¦è§£

### 7.1 é…ç½®æ–‡ä»¶ç»“æ„

```yaml
# settings.yaml.example
# ç³»ç»Ÿé…ç½®
system:
  host: "0.0.0.0"
  port: 8080
  mode: "debug"  # debug, release
  timeout: 60    # è¶…æ—¶æ—¶é—´(ç§’)

# æ•°æ®åº“é…ç½®
db:
  type: "mysql"  # mysql, pgsql, sqlite
  host: "127.0.0.1"
  port: 3306
  username: "root"
  password: "123456"
  dbname: "rbac_admin"
  charset: "utf8mb4"
  max_idle_conns: 10
  max_open_conns: 100
  conn_max_lifetime: 3600

# Redisé…ç½®
redis:
  host: "127.0.0.1"
  port: 6379
  password: ""
  db: 0
  dial_timeout: 5
  read_timeout: 3
  write_timeout: 3
  pool_size: 100

# JWTé…ç½®
jwt:
  secret: "your-secret-key"
  expire: 7200  # è¿‡æœŸæ—¶é—´(ç§’)

# éªŒè¯ç é…ç½®
captcha:
  width: 120
  height: 40
  length: 4
  expire: 300  # è¿‡æœŸæ—¶é—´(ç§’)

# é‚®ç®±é…ç½®
email:
  host: "smtp.qq.com"
  port: 465
  username: "your-email@qq.com"
  password: "your-email-password"
  from: "your-email@qq.com"
  ssl: true

# æ—¥å¿—é…ç½®
log:
  level: "info"  # debug, info, warn, error, dpanic, panic, fatal
  path: "./logs"
  max_size: 100  # å•ä¸ªæ–‡ä»¶æœ€å¤§å¤§å°(MB)
  max_age: 7     # ä¿ç•™å¤©æ•°
  max_backups: 3 # æœ€å¤§å¤‡ä»½æ•°
  compress: true # æ˜¯å¦å‹ç¼©
```
<mcfile name="settings.yaml.example" path="e:\myblog\Goé¡¹ç›®å­¦ä¹ \rbacAdmin\settings.yaml.example"></mcfile>

## 8. éƒ¨ç½²æ­¥éª¤

### 8.1 ç¯å¢ƒå‡†å¤‡

1. **å®‰è£…Goç¯å¢ƒ**ï¼šç¡®ä¿å®‰è£…Go 1.25.1æˆ–æ›´é«˜ç‰ˆæœ¬
2. **å®‰è£…æ•°æ®åº“**ï¼šæ ¹æ®é…ç½®é€‰æ‹©å®‰è£…MySQLã€PostgreSQLæˆ–SQLite
3. **å®‰è£…Redis**ï¼šç¡®ä¿RedisæœåŠ¡æ­£å¸¸è¿è¡Œ
4. **å®‰è£…Git**ï¼šç”¨äºç‰ˆæœ¬æ§åˆ¶

### 8.2 é¡¹ç›®è·å–ä¸é…ç½®

1. **å…‹éš†é¡¹ç›®**ï¼š
   ```bash
   git clone https://your-repository-url/rbacAdmin.git
   cd rbacAdmin
   ```

2. **é…ç½®æ–‡ä»¶å‡†å¤‡**ï¼š
   ```bash
   cp settings.yaml.example settings.yaml
   # æ ¹æ®å®é™…ç¯å¢ƒä¿®æ”¹é…ç½®æ–‡ä»¶
   vim settings.yaml
   ```

3. **å®‰è£…ä¾èµ–**ï¼š
   ```bash
   go mod tidy
   ```

### 8.3 ç¼–è¯‘ä¸è¿è¡Œ

1. **ç¼–è¯‘é¡¹ç›®**ï¼š
   ```bash
   go build -o rbacAdmin main.go
   ```

2. **è¿è¡Œé¡¹ç›®**ï¼š
   ```bash
   # å¼€å‘ç¯å¢ƒ
   ./rbacAdmin
   
   # ç”Ÿäº§ç¯å¢ƒ
   MODE=release ./rbacAdmin
   ```

### 8.4 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å»ºè®®

1. **ä½¿ç”¨Systemdç®¡ç†æœåŠ¡**ï¼šåˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶ç¡®ä¿æœåŠ¡ç¨³å®šè¿è¡Œ
2. **é…ç½®Nginxåå‘ä»£ç†**ï¼šæä¾›HTTPSæ”¯æŒå’Œè´Ÿè½½å‡è¡¡
3. **ä½¿ç”¨Dockerå®¹å™¨åŒ–éƒ¨ç½²**ï¼šç®€åŒ–ç¯å¢ƒé…ç½®å’Œéƒ¨ç½²æµç¨‹
4. **é…ç½®æ—¥å¿—è½®è½¬**ï¼šç¡®ä¿æ—¥å¿—ä¸ä¼šå ç”¨è¿‡å¤šç£ç›˜ç©ºé—´
5. **è®¾ç½®ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡

## 9. æŠ€æœ¯å‡çº§å’Œä»£ç ä¼˜åŒ–å»ºè®®

### 9.1 æŠ€æœ¯å‡çº§å»ºè®®

1. **å‡çº§åˆ°æœ€æ–°ç‰ˆGo**ï¼šäº«å—æ€§èƒ½æå‡å’Œæ–°ç‰¹æ€§
2. **å¼•å…¥Prometheuså’ŒGrafana**ï¼šå®Œå–„ç›‘æ§ä½“ç³»
3. **æ·»åŠ OpenTelemetryæ”¯æŒ**ï¼šå®ç°åˆ†å¸ƒå¼è¿½è¸ª
4. **è€ƒè™‘ä½¿ç”¨gRPC**ï¼šå¯¹äºå¾®æœåŠ¡é—´é€šä¿¡æä¾›æ›´å¥½çš„æ€§èƒ½
5. **å¼•å…¥é…ç½®ä¸­å¿ƒ**ï¼šå¦‚Consulæˆ–ETCDï¼Œå®ç°é…ç½®é›†ä¸­ç®¡ç†å’ŒåŠ¨æ€æ›´æ–°

### 9.2 ä»£ç ä¼˜åŒ–å»ºè®®

1. **å®Œå–„é”™è¯¯å¤„ç†**ï¼š
   ```go
   // ä¼˜åŒ–å‰
   if err != nil {
       panic(err)
   }
   
   // ä¼˜åŒ–å
   if err != nil {
       zap.L().Error("æ“ä½œå¤±è´¥", zap.Error(err))
       return err
   }
   ```

2. **æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•**ï¼šæé«˜ä»£ç è´¨é‡å’Œç¨³å®šæ€§

3. **ä½¿ç”¨ä¾èµ–æ³¨å…¥**ï¼šå‡å°‘ä»£ç è€¦åˆåº¦
   ```go
   // ä¼˜åŒ–å‰
   func InitSomething() {
       global.SomeService = NewSomeService()
   }
   
   // ä¼˜åŒ–å
   type App struct {
       someService SomeServiceInterface
   }
   
   func NewApp(someService SomeServiceInterface) *App {
       return &App{someService: someService}
   }
   ```

4. **æ·»åŠ ä¸­é—´ä»¶å®ç°æ›´ç»†ç²’åº¦çš„æƒé™æ§åˆ¶**ï¼š
   ```go
   func PermissionMiddleware(resource string, action string) gin.HandlerFunc {
       return func(c *gin.Context) {
           userID := getUserIDFromToken(c)
           if !global.Casbin.Enforce(userID, resource, action) {
               c.JSON(http.StatusForbidden, gin.H{"error": "æƒé™ä¸è¶³"})
               c.Abort()
               return
           }
           c.Next()
       }
   }
   ```

5. **ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½**ï¼šæ·»åŠ åˆé€‚çš„ç´¢å¼•ï¼Œä½¿ç”¨é¢„åŠ è½½å‡å°‘N+1æŸ¥è¯¢é—®é¢˜

6. **å®ç°æ–­è·¯å™¨æ¨¡å¼**ï¼šé˜²æ­¢æœåŠ¡é›ªå´©ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§

7. **æ·»åŠ ç¼“å­˜å±‚**ï¼šå¯¹äºé¢‘ç¹è®¿é—®çš„æ•°æ®æ·»åŠ ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›

8. **ä»£ç é‡æ„**ï¼šå°†ä¸šåŠ¡é€»è¾‘ä»APIå¤„ç†å‡½æ•°ä¸­åˆ†ç¦»ï¼Œæé«˜ä»£ç å¯ç»´æŠ¤æ€§

9. **æ·»åŠ APIæ–‡æ¡£**ï¼šä½¿ç”¨Swaggerè‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£ï¼Œä¾¿äºå‰åç«¯åä½œ

10. **å®ç°ä¼˜é›…å…³é—­**ï¼šç¡®ä¿ç³»ç»Ÿæ”¶åˆ°ç»ˆæ­¢ä¿¡å·æ—¶èƒ½å¤Ÿæ­£ç¡®å…³é—­èµ„æº